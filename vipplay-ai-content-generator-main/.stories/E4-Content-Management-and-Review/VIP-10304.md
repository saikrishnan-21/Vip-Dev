# VIP-10304: Approve Content Workflow

**Story ID**: VIP-10304
**Story Type**: Story
**Epic**: E4-Content-Management-and-Review
**Priority**: High
**Story Points**: 3
**Status**: In Progress

## User Story

As a user, I want to approve content so that I can mark it as ready for publication or distribution

## Acceptance Criteria

- [ ] **AC1**: User can click "Approve" button on pending content
- [ ] **AC2**: Approval moves content status from pending → approved
- [ ] **AC3**: Content can be re-approved if it was previously rejected
- [ ] **AC4**: User sees confirmation dialog before approval with content summary
- [ ] **AC5**: Approved content shows "Approved" status badge with timestamp
- [ ] **AC6**: Approval is logged with approver user ID and timestamp
- [ ] **AC7**: Only content in "pending" or "rejected" status can be approved
- [ ] **AC8**: Approval triggers notification (if notification system exists)
- [ ] **AC9**: Content list updates in real-time after approval
- [ ] **AC10**: User isolation enforced - can only approve own content

## Technical Details

### Backend (Partially Implemented)
- **Endpoint**: `POST /api/content/[contentId]/approve` (needs fixes)
- **Request Body**:
  ```json
  {
    "action": "approve"
  }
  ```
- **Response**:
  ```json
  {
    "success": true,
    "content": {
      "_id": "string",
      "status": "approved",
      "approvedAt": "ISO date",
      "approvedBy": "user ID"
    },
    "message": "Content approved successfully"
  }
  ```
- **Status Validation**:
  - Allow approve only if: `status === 'pending' || status === 'rejected'`
  - Return 400 if already approved or in rejected-read-only state
- **User Isolation**: **BUG FOUND** - Endpoint doesn't check `content.userId === user.userId` - MUST FIX
- **Authorization**: All authenticated users can approve their own content (no admin required)
- **Timestamp**: Set `approvedAt` and `approvedBy` (user ID) on approval

### Frontend (To Be Implemented)
- **Component**: Button in content detail view (VIP-10302)
- **Requirements**:
  - "Approve" button visible only for pending/rejected content
  - Disabled if content is approved or published
  - Show confirmation dialog with content title and brief summary
  - Loading state during API call
  - Success/error toast messages
  - Update content status immediately (optimistic UI)
  - List view updates to show approved badge

### Confirmation Dialog Content
- Title: "Approve Content?"
- Body: "Content: {title}" + "Status will change to: Approved"
- Buttons: "Cancel", "Approve"

### Database Changes
- Set `status: 'approved'`
- Set `approvedAt: new Date()`
- Set `approvedBy: user.userId`
- Update `updatedAt: new Date()`

## Definition of Done

- [x] Story details defined
- [ ] Fix user isolation bug in POST /api/content/[contentId]/approve endpoint
- [ ] Add status validation (only approve pending/rejected)
- [ ] Frontend approve button implemented
- [ ] Confirmation dialog implemented
- [ ] Success/error handling with toasts
- [ ] Optimistic UI updates
- [ ] Real-time list view updates
- [ ] All acceptance criteria met
- [ ] Unit tests written
- [ ] E2E tests passing
- [ ] Code reviewed and approved
- [ ] Merged to main branch

## Security Notes

### Critical Bug
The `/api/content/[contentId]/approve` endpoint has a **USER ISOLATION BUG**:
```typescript
// CURRENT (BROKEN):
const content = await db.collection('generated_content').findOne({ _id: contentId });
// ❌ Missing userId check - allows user A to approve user B's content!

// SHOULD BE:
const content = await db.collection('generated_content').findOne({
  _id: contentId,
  userId: user.userId  // ✅ Enforce ownership
});
if (!content) return NextResponse.json({ error: 'Not found' }, { status: 404 });
```

### Additional Security
- Server-side validation of status before approval
- Verify user owns the content
- Audit log approval action
- Rate limit approval endpoint

## Related Stories
- VIP-10302: View Content Details (approval button location)
- VIP-10305: Reject Content (opposite workflow)
- VIP-10306: Bulk Operations (approve multiple)

## Notes

- Approval endpoint exists but has critical user isolation bug
- Need to fix: Add `userId: user.userId` check to MongoDB query
- Consider adding approval queue/workflow for multi-user scenarios
- Could integrate with VIP-10210 (Readability) to require minimum quality scores
