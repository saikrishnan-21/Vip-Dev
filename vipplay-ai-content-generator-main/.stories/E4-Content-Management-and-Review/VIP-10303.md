# VIP-10303: Inline Content Editor

**Story ID**: VIP-10303
**Story Type**: Story
**Epic**: E4-Content-Management-and-Review
**Priority**: High
**Story Points**: 5
**Status**: In Progress

## User Story

As a user, I want to edit generated content inline so that I can make quick fixes without regenerating content and creating new versions

## Acceptance Criteria

- [ ] **AC1**: User can edit title and content in a rich text editor
- [ ] **AC2**: User can update keywords, metadata, and SEO-related fields
- [ ] **AC3**: Changes are saved automatically or with explicit Save button
- [ ] **AC4**: User can see unsaved changes indicator (red dot, asterisk, or "Unsaved" label)
- [ ] **AC5**: User can cancel edits without saving (Discard button)
- [ ] **AC6**: Content can only be edited if it's in pending or approved status
- [ ] **AC7**: Published content cannot be edited (read-only mode)
- [ ] **AC8**: Editor tracks lastEditedBy and updates lastEditedAt timestamp
- [ ] **AC9**: SEO/Readability scores are recalculated after save
- [ ] **AC10**: Edit history is logged for version tracking (VIP-10308)

## Technical Details

### Backend (To Be Implemented)
- **Endpoint**: `PATCH /api/content/[contentId]` (already partially implemented)
- **Request Body**:
  ```json
  {
    "title": "string (1-500 chars)",
    "content": "string (50-50000 chars)",
    "keywords": ["string"],
    "metaDescription": "string (max 160 chars)"
  }
  ```
- **Response**: Updated content object with new timestamps
- **Status Rules**:
  - Can edit: `status === 'pending' || 'approved'`
  - Cannot edit: `status === 'published' || 'rejected'`
  - Return 400 Bad Request if trying to edit read-only status
- **User Isolation**: Verify `content.userId === user.userId` before allowing edit
- **Auto-recalculation**: On save, call `/api/content/analyze` and `/api/content/readability` endpoints

### Frontend (To Be Implemented)
- **Component**: Edit modal in `/app/dashboard/content/page.tsx`
- **Rich Text Editor**: Use Markdown editor or rich text component from shadcn
- **Requirements**:
  - Detect unsaved changes and show indicator
  - Auto-save with debouncing (5 seconds) OR Save button
  - Discard Changes button to revert
  - Show loading state during save
  - Show success/error messages
  - Disable edit fields if content is published
  - Real-time word count and character count
  - Preview mode to see formatted content

### Fields Editable
- `title` - Primary heading
- `content` - Full content body
- `keywords` - Array of keywords
- `metaDescription` - Meta description tag

### Fields Auto-Updated
- `updatedAt` - Set to current timestamp
- `lastEditedBy` - Set to current user ID
- `seoAnalysis` - Recalculated after save
- `readabilityAnalysis` - Recalculated after save

### Database Constraints
- Cannot edit published content (enforce in PATCH handler)
- `lastEditedBy` must be a valid user ID
- Timestamps must be ISO 8601 format

## Definition of Done

- [x] Story details defined
- [ ] PATCH endpoint verified/fixed for edit validation
- [ ] Frontend edit modal component created
- [ ] Rich text editor integrated
- [ ] Unsaved changes detection implemented
- [ ] Auto-save or save button with debouncing
- [ ] SEO/Readability recalculation on save
- [ ] Read-only mode for published content
- [ ] Edit history logged for versions
- [ ] All acceptance criteria met
- [ ] Unit tests written
- [ ] E2E tests passing
- [ ] Code reviewed and approved
- [ ] Merged to main branch

## Implementation Notes

### Editor Libraries
- Option 1: React Markdown Editor (simple, lightweight)
- Option 2: TipTap (advanced, rich features)
- Option 3: Draft.js (complex but powerful)
- Recommendation: Start with Markdown for simplicity

### Validation Rules
- Title: 1-500 characters, non-empty
- Content: 50-50000 characters
- Keywords: Array, max 10 items, each 1-50 chars
- MetaDescription: Max 160 characters (for SEO)

### Performance
- Debounce auto-save to avoid excessive API calls
- Use optimistic UI updates
- Cache previous version for quick discard

### Security
- Server-side validation of all fields
- XSS protection for rich text content
- Escape HTML entities before display
- Verify user ownership on every edit

### Related Stories
- VIP-10307: Nerd Stats (shows metrics in editor)
- VIP-10308: Version History (logs edit history)
- VIP-10304: Approve Workflow (status check)

## Notes

- PATCH endpoint partially implemented, needs status validation
- Auto-recalculation of SEO/readability depends on those endpoints
- Edit history tracking depends on VIP-10308 implementation
- Consider showing before/after preview side-by-side
- Markdown format recommended for rich text to keep it simple
