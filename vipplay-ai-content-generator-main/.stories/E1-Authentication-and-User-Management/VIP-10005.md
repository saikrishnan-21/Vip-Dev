# VIP-10005: Protected Routes Middleware

**Story ID**: VIP-10005
**Story Type**: Story
**Epic**: E1-Authentication-and-User-Management
**Priority**: High
**Story Points**: 3
**Status**: In Progress

## User Story

As a developer, I want middleware to protect routes so that only authenticated users can access dashboard

## Acceptance Criteria

- [x] **AC1**: Next.js middleware protects /dashboard routes
- [x] **AC2**: Middleware protects /api/protected routes
- [x] **AC3**: withAuth() HOF wraps route handlers with authentication
- [x] **AC4**: withSuperadmin() HOF restricts routes to superadmins only
- [x] **AC5**: Token extracted from cookie or Authorization header
- [x] **AC6**: Unauthenticated dashboard access redirects to /login
- [x] **AC7**: Unauthenticated API access returns 401

## Technical Details

**Next.js Middleware** (`middleware.ts`):
- Protects `/dashboard/*` and `/api/protected/*` routes
- Checks token from cookie or Authorization header
- Redirects to `/login` with redirect query param for dashboard
- Returns 401 for protected API routes
- Public routes: `/`, `/login`, `/signup`, `/api/auth/*`

**Route Protection HOFs**:

1. **withAuth(handler, options?)** - Protect any route
   ```typescript
   export const GET = withAuth(async (request, user) => {
     // user.userId, user.email, user.role available
     return NextResponse.json({ data });
   });
   ```

2. **withSuperadmin(handler)** - Superadmin only
   ```typescript
   export const GET = withSuperadmin(async (request, user) => {
     // Only superadmins can access
     return NextResponse.json({ adminData });
   });
   ```

**Example Protected Endpoints**:

1. **GET /api/protected/me** - Get current user profile (any authenticated user)
2. **GET /api/protected/admin/users** - List all users (superadmin only)
   - Query params: `page`, `limit`
   - Returns paginated user list

**Files Created**:
- `lib/auth/with-auth.ts` - Authentication HOFs (withAuth, withSuperadmin)
- `app/api/protected/me/route.ts` - Get current user endpoint
- `app/api/protected/admin/users/route.ts` - List users endpoint (superadmin)

**Files Modified**:
- `middleware.ts` - Added authentication checks and redirects

**Authentication Flow**:
1. Request hits middleware
2. Extract token from cookie/header
3. Verify token with JWT
4. If valid, proceed to route
5. If invalid, redirect/401
6. Route handler receives authenticated user context

**Error Responses**:
- 401: Missing/invalid token
- 403: Insufficient permissions (role check failed)
- 404: User not found in database
- 500: Server error

## Definition of Done

- [x] Code implemented and working
- [x] All acceptance criteria met
- [ ] Unit tests written and passing
- [ ] Code reviewed and approved
- [ ] Merged to main branch
- [x] Documented

## Notes

- Depends on VIP-10004 (JWT Token Management)
- Middleware runs on edge runtime (fast)
- Token can be in cookie (browser) or header (API clients)
- Redirect preserves original URL for post-login navigation
- Example endpoints demonstrate both user and superadmin protection
- Ready for all subsequent protected API routes
