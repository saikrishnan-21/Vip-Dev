# VIP-10006: User Profile Management

**Story ID**: VIP-10006
**Story Type**: Story
**Epic**: E1-Authentication-and-User-Management
**Priority**: Medium
**Story Points**: 3
**Status**: In Progress

## User Story

As a user, I want to view and update my profile information so that I can keep my account current

## Acceptance Criteria

- [x] **AC1**: User can retrieve their profile (GET /api/protected/me)
- [x] **AC2**: User can update profile fields (fullName, email, preferences)
- [x] **AC3**: Email uniqueness validated on update
- [x] **AC4**: Preferences merged with existing settings
- [x] **AC5**: User can change password with current password verification
- [x] **AC6**: New password meets security requirements
- [x] **AC7**: All updates authenticated via JWT

## Technical Details

**Endpoints**:

1. **GET /api/protected/me** - Get current user profile
   - Returns: UserPublic object
   - Already implemented in VIP-10005

2. **PATCH /api/protected/me** - Update user profile
   - Body: `{ fullName?, email?, preferences? }`
   - Validates email uniqueness
   - Merges preferences with existing
   - Returns: Updated UserPublic object

3. **POST /api/protected/change-password** - Change password
   - Body: `{ currentPassword, newPassword, confirmNewPassword }`
   - Verifies current password
   - Validates new password strength
   - Hashes with bcrypt (12 rounds)

**Request Examples**:

```json
// Update Profile
PATCH /api/protected/me
{
  "fullName": "John Smith",
  "preferences": {
    "theme": "dark",
    "defaultWordCount": 2000
  }
}

// Change Password
POST /api/protected/change-password
{
  "currentPassword": "OldPass123",
  "newPassword": "NewSecurePass456",
  "confirmNewPassword": "NewSecurePass456"
}
```

**Validation Schemas**:
- `updateProfileSchema` - Optional fields, at least one required
- `changePasswordSchema` - Current password + new password with confirmation

**Files Created**:
- `app/api/protected/change-password/route.ts` - Password change endpoint

**Files Modified**:
- `app/api/protected/me/route.ts` - Added PATCH handler
- `lib/validations/auth.ts` - Added updateProfileSchema, changePasswordSchema

**Security Features**:
- Email uniqueness check (excludes current user)
- Current password verification before change
- New password strength requirements
- Password hashing with bcrypt (12 rounds)
- Preferences merge (doesn't overwrite undefined fields)

**Profile Update Flow**:
1. User sends PATCH with fields to update
2. Validate input (Zod schema)
3. Check email uniqueness if changed
4. Merge preferences with existing
5. Update database with $set
6. Return updated user profile

**Password Change Flow**:
1. User sends current + new password
2. Validate passwords (Zod schema)
3. Verify current password matches
4. Hash new password (bcrypt 12 rounds)
5. Update password in database
6. Return success message

## Definition of Done

- [x] Code implemented and working
- [x] All acceptance criteria met
- [ ] Unit tests written and passing
- [ ] Code reviewed and approved
- [ ] Merged to main branch
- [x] Documented

## Notes

- Depends on VIP-10005 (Protected Routes Middleware)
- Profile endpoint already existed, added PATCH method
- Preferences are merged, not replaced (preserves unspecified fields)
- Password change requires current password (security)
- Email change triggers uniqueness validation
- updatedAt timestamp set on all updates
