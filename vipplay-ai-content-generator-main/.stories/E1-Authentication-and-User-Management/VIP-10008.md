# VIP-10008: Role-Based Access Control

**Story ID**: VIP-10008
**Story Type**: Story
**Epic**: E1-Authentication-and-User-Management
**Priority**: High
**Story Points**: 3
**Status**: In Progress

## User Story

As a superadmin, I want special access to AI configuration so that I can manage models and settings

## Acceptance Criteria

- [x] **AC1**: Superadmin can view any user's details
- [x] **AC2**: Superadmin can update user roles (user <-> superadmin)
- [x] **AC3**: Superadmin can delete users
- [x] **AC4**: Superadmins cannot delete themselves
- [x] **AC5**: Superadmins cannot demote themselves
- [x] **AC6**: Role-based middleware protects admin endpoints
- [x] **AC7**: Regular users cannot access admin endpoints (403)

## Technical Details

**Superadmin Endpoints** (all require superadmin role):

1. **GET /api/protected/admin/users** - List all users (from VIP-10005)
   - Query: `page`, `limit`
   - Returns paginated user list

2. **GET /api/protected/admin/users/[userId]** - Get user details
   - Returns: Single user object

3. **PATCH /api/protected/admin/users/[userId]/role** - Update user role
   - Body: `{ role: "user" | "superadmin" }`
   - Prevents self-demotion
   - Returns: Updated user

4. **DELETE /api/protected/admin/users/[userId]** - Delete user
   - Prevents self-deletion
   - Returns: Confirmation with deleted user info

**Role Hierarchy**:
- `superadmin`: Full access to all features + user management
- `user`: Access to own data and general features

**Protection Mechanism**:
- `withAuth(handler)` - Any authenticated user
- `withSuperadmin(handler)` - Superadmin only (403 for regular users)
- `hasRole(payload, requiredRole)` - Role check utility

**Files Created**:
- `app/api/protected/admin/users/[userId]/route.ts` - Get/delete user
- `app/api/protected/admin/users/[userId]/role/route.ts` - Update role

**Files Referenced** (from VIP-10005):
- `lib/auth/with-auth.ts` - withAuth, withSuperadmin HOFs
- `lib/auth/get-user-from-request.ts` - hasRole function
- `app/api/protected/admin/users/route.ts` - List users endpoint

**Safety Features**:
- Superadmins cannot delete themselves (prevent lockout)
- Superadmins cannot demote themselves (prevent accidental lockout)
- Regular users get 403 Forbidden on admin endpoints
- Role validation at middleware level

**Example Requests**:

```json
// Update User Role
PATCH /api/protected/admin/users/64f1a2b3c4d5e6f7g8h9i0j1/role
{
  "role": "superadmin"
}

// Delete User
DELETE /api/protected/admin/users/64f1a2b3c4d5e6f7g8h9i0j1
```

**Error Responses**:
- 400: Cannot delete/demote self
- 403: Insufficient permissions (not superadmin)
- 404: User not found
- 500: Server error

## Definition of Done

- [x] Code implemented and working
- [x] All acceptance criteria met
- [ ] Unit tests written and passing
- [ ] Code reviewed and approved
- [ ] Merged to main branch
- [x] Documented

## Notes

- Depends on VIP-10005 (Protected Routes Middleware) - withSuperadmin
- RBAC foundation already implemented in VIP-10005
- This story adds user management endpoints
- Soft delete recommended for production (add deletedAt field)
- Consider audit trail for role changes in production
- Role changes affect user's next login (new JWT generated)
- User management endpoints follow RESTful conventions
- Completes Epic E1: Authentication & User Management
