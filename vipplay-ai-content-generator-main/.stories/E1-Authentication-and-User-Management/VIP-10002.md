# VIP-10002: User Login

**Story ID**: VIP-10002
**Story Type**: Story
**Epic**: E1-Authentication-and-User-Management
**Priority**: High
**Story Points**: 3
**Status**: In Progress

## User Story

As a registered user, I want to log in with my email and password so that I can access my dashboard

## Acceptance Criteria

- [x] **AC1**: User can submit login form with email and password
- [x] **AC2**: Email validation and case-insensitive lookup
- [x] **AC3**: Password verification using bcrypt.compare()
- [x] **AC4**: JWT token generated on successful login (7-day expiration)
- [x] **AC5**: lastLoginAt timestamp updated in database
- [x] **AC6**: API returns JWT token and user data (excluding password)
- [x] **AC7**: Appropriate error messages for invalid credentials

## Technical Details

**Endpoint**: `POST /api/auth/login`

**Request Body**:
```json
{
  "email": "user@example.com",
  "password": "SecurePass123"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Login successful",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "_id": "...",
    "email": "user@example.com",
    "fullName": "John Doe",
    "role": "user",
    "createdAt": "2025-11-10T...",
    "preferences": { ... }
  }
}
```

**Response** (401 Unauthorized):
```json
{
  "success": false,
  "message": "Invalid email or password"
}
```

**Files Created**:
- `lib/auth/jwt.ts` - JWT generation, verification, decoding utilities
- `app/api/auth/login/route.ts` - Login API endpoint

**Files Modified**:
- `lib/types/user.ts` - Added LoginRequest, LoginResponse, JWTPayload interfaces

**JWT Configuration**:
- Algorithm: HS256 (from env or default)
- Expiration: 7 days
- Payload: userId, email, role
- Secret: From JWT_SECRET env variable

**Security Features**:
- Password comparison using bcrypt
- Generic error messages (no user enumeration)
- Case-insensitive email lookup
- Token expiration enforcement
- lastLoginAt tracking

## Definition of Done

- [x] Code implemented and working
- [x] All acceptance criteria met
- [ ] Unit tests written and passing
- [ ] Code reviewed and approved
- [ ] Merged to main branch
- [x] Documented

## Notes

- Depends on VIP-10001 (User Registration) - user must exist in database
- JWT token should be stored in HTTP-only cookie or localStorage (client-side implementation)
- Token contains userId, email, and role for authorization
- Ready for VIP-10004 (JWT Token Management) and VIP-10005 (Protected Routes Middleware)
