# VIP-10004: JWT Token Management

**Story ID**: VIP-10004
**Story Type**: Story
**Epic**: E1-Authentication-and-User-Management
**Priority**: High
**Story Points**: 3
**Status**: In Progress

## User Story

As a developer, I want JWT tokens properly managed so that authentication is secure and scalable

## Acceptance Criteria

- [x] **AC1**: Token verification endpoint validates JWT and returns user data
- [x] **AC2**: Token refresh endpoint generates new token with fresh expiration
- [x] **AC3**: Logout endpoint provides consistent REST API pattern
- [x] **AC4**: Helper utilities extract and validate user from request headers
- [x] **AC5**: Role-based access control helper function
- [x] **AC6**: User existence verified during token operations

## Technical Details

**Endpoints**:

1. **POST /api/auth/verify** - Verify token validity
   - Header: `Authorization: Bearer <token>`
   - Returns: User data if valid
   - Status: 200 (valid), 401 (invalid/expired), 404 (user not found)

2. **POST /api/auth/refresh** - Refresh token
   - Header: `Authorization: Bearer <token>`
   - Returns: New token + user data
   - Status: 200 (success), 401 (invalid token), 404 (user not found)

3. **POST /api/auth/logout** - Logout user
   - Header: `Authorization: Bearer <token>`
   - Returns: Success message
   - Status: 200 (success)
   - Note: Client-side token removal, server logs event

**Helper Functions**:
```typescript
getUserFromRequest(request): JWTPayload | null
hasRole(payload, requiredRole): boolean
```

**Files Created**:
- `app/api/auth/verify/route.ts` - Token verification endpoint
- `app/api/auth/refresh/route.ts` - Token refresh endpoint
- `app/api/auth/logout/route.ts` - Logout endpoint
- `lib/auth/get-user-from-request.ts` - Request helper utilities

**Security Features**:
- Token verification checks user still exists in database
- Fresh token generation on refresh
- Role-based access control helpers
- Superadmin has access to all user-level resources

**Token Refresh Flow**:
1. Client sends existing token
2. Server verifies token validity
3. Server checks user still exists
4. Server generates new token (7-day expiration)
5. Server returns new token + user data

## Definition of Done

- [x] Code implemented and working
- [x] All acceptance criteria met
- [ ] Unit tests written and passing
- [ ] Code reviewed and approved
- [ ] Merged to main branch
- [x] Documented

## Notes

- Depends on VIP-10002 (User Login) - JWT utilities
- Logout is stateless (client-side token removal)
- Future enhancement: Token blacklist with Redis/MongoDB TTL
- Role hierarchy: superadmin > user
- Ready for VIP-10005 (Protected Routes Middleware)
