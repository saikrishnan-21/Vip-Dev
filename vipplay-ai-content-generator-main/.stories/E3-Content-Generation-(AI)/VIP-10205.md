# VIP-10205: Keywords-Based Content Generation Mode

**Story ID**: VIP-10205
**Story Type**: Story
**Epic**: E3-Content-Generation-(AI)
**Priority**: High
**Story Points**: 5
**Status**: To Do

## User Story

As a content creator, I want to generate articles from a list of keywords so that I can create SEO-optimized content targeting specific search terms

## Acceptance Criteria

- [ ] **AC1**: Accept 3-10 keywords as input with primary keyword identification
- [ ] **AC2**: Researcher agent focuses on keyword-specific information gathering
- [ ] **AC3**: Writer agent naturally incorporates all keywords into content
- [ ] **AC4**: SEO optimizer ensures keyword density targets (1-2% primary, 0.5-1% secondary)
- [ ] **AC5**: Generated content includes keyword placement analysis
- [ ] **AC6**: Support for LSI (Latent Semantic Indexing) keyword suggestions
- [ ] **AC7**: Keyword prominence in title, headings, and first/last paragraphs

## Technical Details

**Architecture:**
- **FastAPI Role**: Execute keyword-focused CrewAI workflow, ensure natural keyword integration
- **Next.js Role**: Create generation job, validate keywords, store result
- **Data Flow**: Next.js → FastAPI → CrewAI Agents → Ollama → FastAPI → Next.js → MongoDB

**Keywords-Based Generation Workflow:**

```
User Input (Next.js):
- primary_keyword: "fantasy football waiver wire"
- secondary_keywords: ["week 10 pickups", "streaming options", "injury replacements"]
- word_count: 1500
- tone: "professional"
    ↓
Next.js creates job in MongoDB (status: "queued")
    ↓
Next.js calls FastAPI /api/content/generate/keywords
    ↓
FastAPI CrewService.generate_content(mode="keywords")
    ↓
Task 1: Keyword Research Task (Researcher Agent)
  → Research each keyword individually
  → Find related LSI keywords
  → Gather statistics and data for keyword topics
  → Identify search intent for each keyword
  → Output: Keyword-focused research brief
    ↓
Task 2: Keyword Writing Task (Writer Agent)
  → Generate article structure around primary keyword
  → Naturally integrate all keywords (avoid keyword stuffing)
  → Place primary keyword in:
    - Title (H1)
    - First 100 words
    - At least one H2 heading
    - Last paragraph
  → Distribute secondary keywords throughout
  → Output: Keyword-optimized draft article
    ↓
Task 3: Keyword SEO Task (SEO Optimizer Agent)
  → Verify keyword density (primary: 1-2%, secondary: 0.5-1%)
  → Check keyword placement in strategic locations
  → Suggest LSI keywords to add
  → Generate keyword-rich meta title and description
  → Calculate keyword optimization score
  → Output: Final article + keyword analysis
    ↓
FastAPI returns result to Next.js
    ↓
Next.js stores in MongoDB (status: "completed")
```

**Task Definitions (`tasks/generation_tasks.py` updates):**

```python
def create_keyword_research_task(
    primary_keyword: str,
    secondary_keywords: list[str],
    context: str = ""
) -> Task:
    """
    Create keyword-focused research task

    Args:
        primary_keyword: Main target keyword
        secondary_keywords: Supporting keywords (3-10)
        context: Additional context (optional)

    Returns:
        CrewAI Task instance
    """
    researcher = create_researcher_agent()

    keywords_list = f"Primary: {primary_keyword}\nSecondary: {', '.join(secondary_keywords)}"

    return Task(
        description=f"""
        Research the following keywords to create SEO-optimized content:

        {keywords_list}
        {f"Additional Context: {context}" if context else ""}

        Your research goals:
        1. **Primary Keyword Analysis**
           - Search intent (informational, navigational, transactional)
           - Current top-ranking content for this keyword
           - Key topics and subtopics related to this keyword
           - Statistics and data points

        2. **Secondary Keywords Research**
           - How each secondary keyword relates to primary
           - Supporting information for each keyword
           - Natural ways to incorporate them

        3. **LSI Keywords**
           - Identify 5-10 related LSI keywords
           - Terms that commonly appear with the primary keyword

        4. **Content Structure**
           - Suggest article structure that naturally incorporates all keywords
           - Recommend heading placements for keywords

        Search the internal knowledge base and external sources.
        Focus on information that helps naturally incorporate keywords without stuffing.
        """,
        agent=researcher,
        expected_output="""
        A keyword-focused research brief containing:
        - Search intent analysis for primary keyword
        - Key information for each keyword
        - LSI keyword suggestions (5-10)
        - Recommended content structure with keyword placements
        - Statistics and data to support each keyword topic
        - Natural phrase variations for each keyword
        """
    )


def create_keyword_writing_task(
    primary_keyword: str,
    secondary_keywords: list[str],
    word_count: int,
    tone: str,
    research_task: Task
) -> Task:
    """
    Create keyword-optimized writing task

    Args:
        primary_keyword: Main target keyword
        secondary_keywords: Supporting keywords
        word_count: Target word count
        tone: Writing tone
        research_task: Keyword research task

    Returns:
        CrewAI Task instance
    """
    writer = create_writer_agent()

    tone_guidance = {
        "professional": "Write in a professional, authoritative tone.",
        "casual": "Write in a casual, friendly tone.",
        "conversational": "Write in a conversational tone."
    }

    return Task(
        description=f"""
        Write an SEO-optimized article targeting these keywords:

        Primary Keyword: {primary_keyword}
        Secondary Keywords: {', '.join(secondary_keywords)}
        Target Word Count: {word_count} words
        Tone: {tone_guidance.get(tone, tone_guidance['professional'])}

        Use the keyword research to create naturally optimized content.

        **Keyword Placement Requirements:**

        1. **Primary Keyword** (must appear in):
           - Article title/H1 (at the beginning if possible)
           - First 100 words of introduction
           - At least one H2 heading
           - Last paragraph/conclusion
           - URL-friendly slug form in meta

        2. **Secondary Keywords** (distribute naturally):
           - Use 1-2 secondary keywords per major section
           - Include in H2 or H3 headings where natural
           - Spread throughout article (not clustered)

        3. **LSI Keywords**:
           - Incorporate LSI keywords suggested by researcher
           - Use variations and related terms naturally

        **Writing Guidelines:**
        - NEVER keyword stuff (forced, unnatural repetition)
        - Use keywords in context, not awkwardly placed
        - Use variations (synonyms, different word orders)
        - Write for humans first, search engines second
        - Target primary keyword density: 1-2%
        - Target secondary keyword density: 0.5-1% each

        **Article Structure:**
        1. Introduction with primary keyword in first paragraph
        2. Main sections using keywords in headings naturally
        3. Conclusion reinforcing primary keyword

        Write {word_count} words (±10%) that reads naturally while being keyword-optimized.
        """,
        agent=writer,
        context=[research_task],
        expected_output=f"""
        A keyword-optimized article in markdown with:
        - Primary keyword in title, introduction, heading, conclusion
        - Secondary keywords naturally distributed
        - LSI keywords incorporated throughout
        - Approximately {word_count} words
        - Natural, engaging writing (not stuffed)
        """
    )


def create_keyword_seo_task(
    primary_keyword: str,
    secondary_keywords: list[str],
    writing_task: Task
) -> Task:
    """
    Create keyword-focused SEO optimization task

    Args:
        primary_keyword: Main target keyword
        secondary_keywords: Supporting keywords
        writing_task: Writing task

    Returns:
        CrewAI Task instance
    """
    seo_optimizer = create_seo_optimizer_agent()

    return Task(
        description=f"""
        Analyze and optimize keyword usage in the article.

        Target Keywords:
        - Primary: {primary_keyword}
        - Secondary: {', '.join(secondary_keywords)}

        Your optimization tasks:

        1. **Keyword Density Analysis**
           - Calculate density for primary keyword (target: 1-2%)
           - Calculate density for each secondary keyword (target: 0.5-1%)
           - Identify any keyword stuffing issues
           - Suggest adjustments if needed

        2. **Keyword Placement Verification**
           - Confirm primary keyword in title (ideally at start)
           - Verify primary keyword in first 100 words
           - Check primary keyword in at least one H2 heading
           - Confirm primary keyword in conclusion
           - Verify secondary keywords in headings/body

        3. **LSI Keywords**
           - Identify LSI keywords already used
           - Suggest additional LSI keywords to add
           - Recommend natural placements

        4. **Meta Data Optimization**
           - Meta Title: Include primary keyword (50-60 chars)
           - Meta Description: Include primary + 1-2 secondary keywords (150-160 chars)
           - URL Slug: Primary keyword in URL-friendly format

        5. **Keyword Prominence Score** (0-100)
           - Primary keyword placement (40 points)
           - Secondary keyword distribution (30 points)
           - LSI keyword usage (15 points)
           - Natural integration (no stuffing) (15 points)

        6. **Optimization Recommendations**
           - If density too high: Suggest rephrasing
           - If density too low: Suggest natural additions
           - Recommend heading improvements
           - Suggest LSI keyword placements

        Return comprehensive keyword analysis with the optimized article.
        """,
        agent=seo_optimizer,
        context=[writing_task],
        expected_output="""
        JSON object with:
        {
          "optimized_content": "Full article (markdown)",
          "primary_keyword": "main keyword",
          "primary_keyword_density": 1.5,
          "primary_keyword_count": 22,
          "secondary_keywords": [
            {"keyword": "keyword1", "density": 0.8, "count": 12},
            {"keyword": "keyword2", "density": 0.6, "count": 9}
          ],
          "lsi_keywords_used": ["term1", "term2", "term3"],
          "lsi_keywords_suggested": ["term4", "term5"],
          "keyword_placements": {
            "in_title": true,
            "in_first_100_words": true,
            "in_headings": ["h2", "h2"],
            "in_conclusion": true
          },
          "keyword_prominence_score": 88,
          "meta_title": "Primary Keyword | Secondary Keyword - Brand",
          "meta_description": "Description with primary and secondary keywords",
          "url_slug": "primary-keyword-topic",
          "optimization_recommendations": [
            "Consider adding 'related term' in section 2",
            "Primary keyword density optimal"
          ],
          "seo_score": 90,
          "readability_score": 67.3,
          "word_count": 1489,
          "reading_time_minutes": 7
        }
        """
    )
```

**Update CrewService (`services/crew_service.py`):**

```python
def _create_tasks_for_mode(
    self,
    mode: str,
    input_data: dict,
    word_count: int
) -> list[Task]:
    """Create task sequence for given mode"""

    # ... existing topic mode ...

    elif mode == "keywords":
        primary_keyword = input_data.get("primary_keyword", "")
        secondary_keywords = input_data.get("secondary_keywords", [])
        tone = input_data.get("tone", "professional")
        context = input_data.get("context", "")

        # Validate keywords
        if not primary_keyword:
            raise ValueError("Primary keyword is required")
        if not secondary_keywords or len(secondary_keywords) < 3:
            raise ValueError("At least 3 secondary keywords required")
        if len(secondary_keywords) > 10:
            raise ValueError("Maximum 10 secondary keywords allowed")

        # Create keyword-focused tasks
        research_task = create_keyword_research_task(
            primary_keyword,
            secondary_keywords,
            context
        )
        writing_task = create_keyword_writing_task(
            primary_keyword,
            secondary_keywords,
            word_count,
            tone,
            research_task
        )
        seo_task = create_keyword_seo_task(
            primary_keyword,
            secondary_keywords,
            writing_task
        )

        return [research_task, writing_task, seo_task]

    # ... other modes ...
```

**Update Content Router (`routers/content.py`):**

```python
class KeywordsGenerateRequest(BaseModel):
    """Keywords-based content generation request"""
    mode: Literal["keywords"] = "keywords"
    primary_keyword: str = Field(..., min_length=2, max_length=100)
    secondary_keywords: list[str] = Field(..., min_items=3, max_items=10)
    word_count: int = Field(default=1500, ge=500, le=3000)
    tone: Literal["professional", "casual", "conversational"] = "professional"
    context: Optional[str] = Field(None, max_length=1000)
    job_id: str
    user_id: str


@router.post("/generate/keywords", response_model=GenerateResponse)
async def generate_from_keywords(
    request: KeywordsGenerateRequest,
    background_tasks: BackgroundTasks
):
    """
    Generate SEO-optimized content from keywords

    Requires:
    - 1 primary keyword (main focus)
    - 3-10 secondary keywords (supporting terms)

    The system will:
    1. Research each keyword for content ideas
    2. Write article naturally incorporating all keywords
    3. Optimize keyword density and placement
    """
    try:
        logger.info(
            f"Keywords generation: job_id={request.job_id}, "
            f"primary={request.primary_keyword}, "
            f"secondary_count={len(request.secondary_keywords)}"
        )

        background_tasks.add_task(
            _execute_keywords_generation,
            request
        )

        return GenerateResponse(
            success=True,
            job_id=request.job_id,
            message="Keyword-based generation started"
        )

    except Exception as e:
        logger.error(f"Failed to queue keywords generation: {e}")
        return GenerateResponse(
            success=False,
            job_id=request.job_id,
            message="Failed to start generation",
            error=str(e)
        )


async def _execute_keywords_generation(request: KeywordsGenerateRequest):
    """Execute keywords-based generation in background"""
    try:
        result = await crew_service.generate_content(
            mode="keywords",
            input_data={
                "primary_keyword": request.primary_keyword,
                "secondary_keywords": request.secondary_keywords,
                "tone": request.tone,
                "context": request.context or ""
            },
            word_count=request.word_count
        )
        logger.info(f"Keywords generation completed: job_id={request.job_id}")
    except Exception as e:
        logger.error(f"Keywords generation failed: job_id={request.job_id}, error={e}")
```

## Definition of Done

- [ ] Keyword research task definition created
- [ ] Keyword writing task with natural integration guidelines
- [ ] Keyword SEO task with density and placement analysis
- [ ] CrewService implements "keywords" mode with validation
- [ ] Content router `/api/content/generate/keywords` endpoint created
- [ ] Keyword density calculations accurate (1-2% primary, 0.5-1% secondary)
- [ ] Keyword placement verification (title, intro, headings, conclusion)
- [ ] LSI keyword suggestion feature implemented
- [ ] Tests written for keyword optimization
- [ ] Code reviewed and approved
- [ ] Merged to dev branch

## Notes

**Implementation Status**: ⏳ Depends on VIP-10204 (task definitions structure)

**Keywords Mode Characteristics:**
- **Input**: 1 primary keyword + 3-10 secondary keywords
- **Research Focus**: Keyword-specific information gathering and LSI keyword discovery
- **Agent Flow**: Full 3-agent workflow with keyword emphasis
- **Optimization Target**: 1-2% density for primary, 0.5-1% for secondary keywords
- **Key Differentiator**: Heavy emphasis on natural keyword integration without stuffing

**Example Keyword Sets:**
```json
{
  "primary_keyword": "fantasy football waiver wire",
  "secondary_keywords": [
    "week 10 pickups",
    "streaming options",
    "injury replacements",
    "free agent targets",
    "waiver priority"
  ]
}
```

**Keyword Placement Strategy:**
- **Title (H1)**: Primary keyword at the beginning
- **First 100 words**: Primary keyword naturally integrated
- **H2 Headings**: Primary keyword in at least one, secondary keywords in others
- **Body Sections**: Distribute keywords evenly, avoid clustering
- **Conclusion**: Reinforce primary keyword
- **Meta Description**: Primary + 1-2 secondary keywords

**LSI (Latent Semantic Indexing) Keywords:**
- Terms and phrases semantically related to primary keyword
- Help search engines understand context
- Examples for "fantasy football waiver wire":
  - "free agent pickups"
  - "roster moves"
  - "add/drop decisions"
  - "streaming strategy"

**Keyword Density Calculations:**
```
Density (%) = (Keyword Count / Total Words) × 100

Example:
- Article: 1500 words
- Primary keyword appears 22 times
- Density: (22 / 1500) × 100 = 1.47% ✅ (target: 1-2%)
```

**Anti-Keyword Stuffing Checks:**
1. Keyword appears naturally in context
2. Variations used (not exact match every time)
3. Phrases flow naturally when read aloud
4. Keyword proximity not too close (avoid clusters)
5. Readability score maintained above 60

**Performance Expectations:**
- Research: 45-75 seconds (more keyword analysis)
- Writing: 60-120 seconds
- SEO: 20-40 seconds (detailed keyword analysis)
- Total: 2.5-4 minutes

**Next Stories:**
- VIP-10206: Trends-based generation (integrates Google Trends data)
- VIP-10207: Spin existing article (rewrite with keyword focus)
