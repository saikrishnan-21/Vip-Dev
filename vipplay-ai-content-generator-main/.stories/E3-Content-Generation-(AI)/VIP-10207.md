# VIP-10207: Spin Existing Article Mode

**Story ID**: VIP-10207
**Story Type**: Story
**Epic**: E3-Content-Generation-(AI)
**Priority**: Medium
**Story Points**: 8
**Status**: To Do

## User Story

As a content creator, I want to spin/rewrite existing articles so that I can create unique versions of content while maintaining core information and improving quality

## Acceptance Criteria

- [ ] **AC1**: Accept article ID or full article text as input
- [ ] **AC2**: Writer agent rewrites content maintaining key facts and structure
- [ ] **AC3**: SEO optimizer ensures uniqueness while preserving keyword targets
- [ ] **AC4**: Plagiarism similarity score calculated (target: <30% similarity)
- [ ] **AC5**: Support for spin intensity levels (light, medium, heavy)
- [ ] **AC6**: Option to change tone/style while spinning
- [ ] **AC7**: NO research agent (only Writer + SEO workflow)

## Technical Details

**Architecture:**
- **FastAPI Role**: Execute 2-agent workflow (Writer + SEO only, NO Research)
- **Next.js Role**: Fetch original article from MongoDB, create job, store spun version
- **Data Flow**: Next.js (article from MongoDB) → FastAPI → Writer + SEO Agents → Ollama → Next.js → MongoDB

**Spin Article Generation Workflow:**

```
User Input (Next.js):
- source_article_id: "abc123" (from MongoDB articles collection)
- source_article_text: "Full original article content..."
- spin_intensity: "medium"  # light, medium, heavy
- target_tone: "conversational"  # optional tone change
- word_count_target: 1500  # optional, default: match original ±10%
    ↓
Next.js fetches original article from MongoDB
    ↓
Next.js creates job in MongoDB (status: "queued")
    ↓
Next.js calls FastAPI /api/content/generate/spin
    ↓
FastAPI CrewService.generate_content(mode="spin")
    ↓
Task 1: Spin Writing Task (Writer Agent) - NO RESEARCH!
  → Analyze original article structure
  → Identify key facts to preserve
  → Rewrite with spin intensity:
    - Light: Rephrase sentences, keep structure
    - Medium: Restructure sections, rewrite all
    - Heavy: Complete rewrite, different angle
  → Change tone if requested
  → Output: Spun article (unique version)
    ↓
Task 2: Spin SEO Task (SEO Optimizer Agent)
  → Calculate similarity score vs original
  → Ensure sufficient uniqueness (<30% similarity)
  → Optimize keywords (may differ from original)
  → Add meta data
  → Verify readability maintained or improved
  → Output: Unique spun article + uniqueness metrics
    ↓
FastAPI returns result to Next.js
    ↓
Next.js stores spun article in MongoDB
```

**Task Definitions (`tasks/generation_tasks.py` updates):**

```python
def create_spin_writing_task(
    original_article: str,
    spin_intensity: str,
    target_tone: str,
    word_count_target: int
) -> Task:
    """
    Create article spinning/rewriting task

    Args:
        original_article: The original article text to spin
        spin_intensity: How heavily to rewrite (light, medium, heavy)
        target_tone: Desired tone for spun article
        word_count_target: Target word count for spun version

    Returns:
        CrewAI Task instance
    """
    writer = create_writer_agent()

    spin_guidelines = {
        "light": """
        **Light Spin** (30-50% rewrite):
        - Rephrase most sentences while keeping structure
        - Use synonyms and alternative phrasings
        - Keep same paragraph order and flow
        - Preserve all key facts, statistics, and quotes
        - Minor reorganization of subsections allowed
        - Goal: Avoid plagiarism while maintaining essence
        """,
        "medium": """
        **Medium Spin** (50-70% rewrite):
        - Completely rewrite all sentences
        - Restructure some sections and paragraphs
        - Change introduction and conclusion approaches
        - Use different examples where possible
        - Preserve core facts but present differently
        - Change heading styles and formatting
        - Goal: Significantly different but same information
        """,
        "heavy": """
        **Heavy Spin** (70-90% rewrite):
        - Complete rewrite from different angle
        - Restructure entire article
        - Different introduction hook and conclusion
        - Present information in new order
        - Add new examples and analogies
        - Change perspective (e.g., problem-first vs. solution-first)
        - Significantly different tone and voice
        - Goal: Fresh article with same core information
        """
    }

    tone_guidance = {
        "professional": "professional, authoritative tone",
        "casual": "casual, friendly tone",
        "conversational": "conversational, engaging tone"
    }

    return Task(
        description=f"""
        Rewrite the following article to create a unique version:

        **Original Article:**
        {original_article}

        **Spin Parameters:**
        - Intensity: {spin_intensity}
        - Target Tone: {tone_guidance.get(target_tone, "same as original")}
        - Target Word Count: {word_count_target} words (±10%)

        {spin_guidelines.get(spin_intensity, spin_guidelines['medium'])}

        **Rewriting Guidelines:**

        1. **Must Preserve:**
           - All facts, statistics, and data points
           - Core message and key takeaways
           - Important quotes (can rephrase attribution)
           - Logical flow of information

        2. **Must Change:**
           - Sentence structure and phrasing (100%)
           - Word choices (use synonyms, alternatives)
           - Paragraph organization (depending on intensity)
           - Introduction and conclusion (fresh hooks)
           - Heading styles and formatting

        3. **Quality Standards:**
           - No grammatical errors
           - Improved readability if possible
           - Natural, engaging writing
           - No awkward phrasing from spinning
           - Maintain or improve coherence

        4. **Uniqueness Requirements:**
           - Target: <30% similarity to original
           - No copy-paste of full sentences (except quotes)
           - Different structure and presentation
           - Unique perspective or angle

        5. **Tone Adjustment:**
           - If tone change requested, apply consistently throughout
           - Maintain professionalism even in casual tone
           - Keep information accurate regardless of tone

        **Output Requirements:**
        - Markdown format with proper headings
        - {word_count_target} words (±10%)
        - Engaging title (different from original)
        - No plagiarism indicators
        - Natural, polished writing

        IMPORTANT: This is a rewrite, not a summary. Cover all topics from the original.
        """,
        agent=writer,
        expected_output=f"""
        A unique spun article in markdown with:
        - Completely rewritten content ({spin_intensity} spin intensity)
        - All original facts preserved
        - {target_tone} tone applied
        - Approximately {word_count_target} words
        - Unique structure and presentation
        - Professional quality writing
        """
    )


def create_spin_seo_task(
    original_article: str,
    spin_intensity: str,
    writing_task: Task
) -> Task:
    """
    Create SEO optimization task for spun article

    Args:
        original_article: The original article for comparison
        spin_intensity: Spin intensity level
        writing_task: Spin writing task

    Returns:
        CrewAI Task instance
    """
    seo_optimizer = create_seo_optimizer_agent()

    return Task(
        description=f"""
        Analyze the spun article for uniqueness and optimize for SEO.

        Original Article:
        {original_article[:1000]}...

        Spin Intensity: {spin_intensity}

        Your optimization tasks:

        1. **Uniqueness Analysis**
           - Compare spun article to original
           - Calculate similarity percentage (target: <30%)
           - Identify any sections that are too similar
           - Check for unintentional plagiarism
           - Verify sentence structure differences

        2. **Uniqueness Metrics:**
           - Word-level similarity
           - Sentence-level similarity
           - Paragraph-level similarity
           - Overall uniqueness score (0-100, target: >70)

        3. **Quality Check**
           - Verify all facts from original are preserved
           - Check for grammatical errors
           - Ensure natural, coherent flow
           - Confirm tone consistency
           - Assess readability (should match or exceed original)

        4. **SEO Optimization**
           - Identify primary and secondary keywords
           - Generate SEO-optimized meta title and description
           - Calculate keyword density
           - Suggest improvements for keyword placement
           - URL slug recommendation

        5. **Plagiarism Prevention**
           - Highlight any sentences/phrases too similar to original
           - Recommend further rewrites if needed
           - Verify uniqueness passes minimum threshold (70%)

        6. **Comparison Metrics**
           - Original word count vs spun word count
           - Readability score comparison
           - Keyword preservation analysis
           - Information completeness check

        Return comprehensive uniqueness analysis with the optimized article.
        """,
        agent=seo_optimizer,
        context=[writing_task],
        expected_output="""
        JSON object with:
        {
          "optimized_content": "Full spun article (markdown)",
          "uniqueness_metrics": {
            "overall_similarity": 22.5,
            "uniqueness_score": 77.5,
            "word_level_similarity": 35.2,
            "sentence_level_similarity": 18.3,
            "paragraph_level_similarity": 25.1,
            "passes_threshold": true
          },
          "quality_metrics": {
            "facts_preserved": true,
            "tone_consistent": true,
            "grammar_errors": 0,
            "readability_score": 68.5,
            "readability_comparison": "+3.2 (improved)"
          },
          "seo_analysis": {
            "primary_keyword": "keyword",
            "secondary_keywords": ["keyword1", "keyword2"],
            "keyword_density": 1.8,
            "meta_title": "SEO-optimized title",
            "meta_description": "Compelling description",
            "url_slug": "unique-article-slug"
          },
          "word_count": 1480,
          "word_count_original": 1520,
          "word_count_change": -40,
          "sections_needing_rewrite": [],
          "overall_assessment": "Passes all uniqueness and quality checks",
          "seo_score": 85,
          "reading_time_minutes": 7
        }
        """
    )
```

**Update CrewService (`services/crew_service.py`):**

```python
elif mode == "spin":
    original_article = input_data.get("original_article", "")
    spin_intensity = input_data.get("spin_intensity", "medium")
    target_tone = input_data.get("target_tone", "professional")

    # Validate input
    if not original_article:
        raise ValueError("Original article is required")
    if spin_intensity not in ["light", "medium", "heavy"]:
        raise ValueError("Spin intensity must be: light, medium, or heavy")

    # Detect original word count if not specified
    if word_count == 1500:  # Default value
        original_words = len(original_article.split())
        word_count = original_words

    # Create spin tasks (NO RESEARCH!)
    writing_task = create_spin_writing_task(
        original_article,
        spin_intensity,
        target_tone,
        word_count
    )
    seo_task = create_spin_seo_task(
        original_article,
        spin_intensity,
        writing_task
    )

    # Only 2 agents for spin mode
    return [writing_task, seo_task]
```

**Update Content Router (`routers/content.py`):**

```python
class SpinGenerateRequest(BaseModel):
    """Spin/rewrite existing article request"""
    mode: Literal["spin"] = "spin"
    source_article_id: Optional[str] = Field(None, description="Article ID from MongoDB")
    original_article: str = Field(..., min_length=100, description="Full original article text")
    spin_intensity: Literal["light", "medium", "heavy"] = "medium"
    target_tone: Literal["professional", "casual", "conversational"] = "professional"
    word_count_target: Optional[int] = Field(None, ge=500, le=3000)
    job_id: str
    user_id: str


@router.post("/generate/spin", response_model=GenerateResponse)
async def generate_spin_article(
    request: SpinGenerateRequest,
    background_tasks: BackgroundTasks
):
    """
    Spin/rewrite an existing article to create unique version

    Spin Intensities:
    - light: 30-50% rewrite, preserve structure
    - medium: 50-70% rewrite, moderate restructuring
    - heavy: 70-90% rewrite, complete restructuring

    Target uniqueness: <30% similarity to original
    """
    try:
        logger.info(
            f"Spin generation: job_id={request.job_id}, "
            f"intensity={request.spin_intensity}, "
            f"article_length={len(request.original_article.split())} words"
        )

        background_tasks.add_task(
            _execute_spin_generation,
            request
        )

        return GenerateResponse(
            success=True,
            job_id=request.job_id,
            message=f"Article spinning started ({request.spin_intensity} intensity)"
        )

    except Exception as e:
        logger.error(f"Failed to queue spin generation: {e}")
        return GenerateResponse(
            success=False,
            job_id=request.job_id,
            message="Failed to start generation",
            error=str(e)
        )


async def _execute_spin_generation(request: SpinGenerateRequest):
    """Execute spin generation in background"""
    try:
        # Auto-detect word count if not specified
        word_count = request.word_count_target
        if not word_count:
            word_count = len(request.original_article.split())

        result = await crew_service.generate_content(
            mode="spin",
            input_data={
                "original_article": request.original_article,
                "spin_intensity": request.spin_intensity,
                "target_tone": request.target_tone
            },
            word_count=word_count
        )
        logger.info(f"Spin generation completed: job_id={request.job_id}")
    except Exception as e:
        logger.error(f"Spin generation failed: job_id={request.job_id}, error={e}")
```

## Definition of Done

- [ ] Spin writing task definition created
- [ ] Spin SEO task with uniqueness analysis
- [ ] CrewService implements "spin" mode (2-agent workflow only)
- [ ] Content router `/api/content/generate/spin` endpoint created
- [ ] Support for light, medium, heavy spin intensities
- [ ] Uniqueness scoring (<30% similarity target)
- [ ] Tone change capability
- [ ] Integration with Next.js articles collection
- [ ] Tests written for spin generation and uniqueness
- [ ] Code reviewed and approved
- [ ] Merged to dev branch

## Notes

**Implementation Status**: ⏳ Depends on VIP-10204 (task definitions)

**Spin Mode Characteristics:**
- **Input**: Full original article text
- **Agent Flow**: Only 2 agents (Writer + SEO) - NO Research agent!
- **Word Count**: Match original ±10% (or specify custom)
- **Uniqueness Target**: <30% similarity, >70% uniqueness score
- **Key Differentiator**: Fastest mode, no research phase

**Spin Intensity Levels:**

1. **Light Spin** (30-50% rewrite):
   - Rephrase sentences
   - Use synonyms
   - Keep structure
   - Minor reorganization
   - **Use Case**: Quick uniqueness for republishing

2. **Medium Spin** (50-70% rewrite):
   - Rewrite all sentences
   - Moderate restructuring
   - Different intro/conclusion
   - **Use Case**: Standard content spinning

3. **Heavy Spin** (70-90% rewrite):
   - Complete rewrite
   - Different angle/perspective
   - Major restructuring
   - **Use Case**: Create substantially different version

**Uniqueness Calculation:**

```python
# Simplified similarity algorithm
def calculate_similarity(original, spun):
    # Word-level: Jaccard similarity of word sets
    # Sentence-level: Cosine similarity of sentence vectors
    # Paragraph-level: Structural similarity
    # Overall: Weighted average
    return similarity_percentage  # 0-100

uniqueness_score = 100 - similarity_percentage
```

**Quality Assurance:**
- All facts from original must be preserved
- No grammatical errors introduced
- Readability maintained or improved
- Coherent flow and structure
- Natural language (not robotic spinning)

**Integration with MongoDB:**

```typescript
// Next.js fetches article to spin
const originalArticle = await db.collection('articles').findOne({
  _id: new ObjectId(articleId)
});

// Call FastAPI
await fetch(`${process.env.FASTAPI_URL}/api/content/generate/spin`, {
  method: 'POST',
  body: JSON.stringify({
    mode: 'spin',
    source_article_id: articleId,
    original_article: originalArticle.content,
    spin_intensity: 'medium',
    target_tone: 'professional',
    job_id: newJobId,
    user_id: userId
  })
});
```

**Performance Expectations (Fastest Mode):**
- Writing: 45-90 seconds (depends on length and intensity)
- SEO: 15-30 seconds (uniqueness analysis)
- Total: 1-2 minutes (no research phase!)

**Use Cases:**
- Republish competitor content with uniqueness
- Create multiple variations of same topic
- Update old articles with fresh language
- Adapt content for different audiences (tone change)
- Avoid duplicate content penalties

**Plagiarism Detection:**
- Word-level comparison
- Sentence structure analysis
- Paragraph similarity checking
- N-gram matching (trigrams, 4-grams)
- Overall uniqueness score calculation

**Error Handling:**
- If uniqueness <70%, suggest heavier spin intensity
- If facts lost, reject and retry
- If readability drops significantly, adjust rewrite
- If word count deviates >20%, flag for review

**Next Stories:**
- VIP-10208: Bulk generation (queue 10-50 articles for batch spinning)
- VIP-10209: SEO analysis (detailed SEO scoring for all generated content)
