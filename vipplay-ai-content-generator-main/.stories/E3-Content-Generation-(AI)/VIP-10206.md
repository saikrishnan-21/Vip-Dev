# VIP-10206: Trends-Based Content Generation Mode

**Story ID**: VIP-10206
**Story Type**: Story
**Epic**: E3-Content-Generation-(AI)
**Priority**: High
**Story Points**: 5
**Status**: To Do

## User Story

As a content creator, I want to generate articles based on trending topics so that I can write about what's currently popular and maximize reader engagement

## Acceptance Criteria

- [ ] **AC1**: Accept trend topic/query as input from MongoDB trends collection
- [ ] **AC2**: Researcher agent gathers real-time data about the trend
- [ ] **AC3**: Writer agent creates timely, trend-focused content
- [ ] **AC4**: SEO optimizer targets trend-related keywords
- [ ] **AC5**: Generated content includes trend context (why it's trending, statistics)
- [ ] **AC6**: Content emphasizes timeliness and current relevance
- [ ] **AC7**: Integration with Next.js trends tracking system

## Technical Details

**Architecture:**
- **FastAPI Role**: Execute trend-focused CrewAI workflow, emphasize timeliness
- **Next.js Role**: Fetch trend from MongoDB, create job, store result
- **Data Flow**: Next.js (trends from MongoDB) → FastAPI → CrewAI Agents → Ollama → Next.js → MongoDB

**Trends-Based Generation Workflow:**

```
User Selection (Next.js):
- trend_id: "67890abcdef" (from MongoDB trends collection)
- trend_query: "Tyreek Hill injury Week 10"
- trend_data: {
    search_volume: 15000,
    trend_date: "2024-11-15",
    related_queries: ["Tyreek Hill status", "Chiefs WR injury"]
  }
- word_count: 1200
- tone: "professional"
    ↓
Next.js creates job in MongoDB (status: "queued")
    ↓
Next.js calls FastAPI /api/content/generate/trends
    ↓
FastAPI CrewService.generate_content(mode="trends")
    ↓
Task 1: Trend Research Task (Researcher Agent)
  → Verify trend is still active/relevant
  → Gather real-time updates and breaking news
  → Find expert reactions and analysis
  → Collect statistics and impact data
  → Identify related trending topics
  → Output: Time-sensitive research brief
    ↓
Task 2: Trend Writing Task (Writer Agent)
  → Create urgent, newsworthy article
  → Emphasize "breaking news" angle if applicable
  → Include:
    - What's happening (the trend)
    - Why it matters (impact/significance)
    - Latest updates (real-time info)
    - Expert analysis
    - What's next (predictions/outlook)
  → Uses fast model (gpt-oss) for speed
  → Output: Timely trend article
    ↓
Task 3: Trend SEO Task (SEO Optimizer Agent)
  → Target trend-related keywords
  → Optimize for news/trending searches
  → Add timeliness indicators to meta data
  → Include last-updated timestamp
  → Output: Trend-optimized article
    ↓
FastAPI returns result to Next.js
    ↓
Next.js stores in MongoDB with trend metadata
```

**Task Definitions (`tasks/generation_tasks.py` updates):**

```python
def create_trend_research_task(
    trend_query: str,
    trend_data: dict,
    context: str = ""
) -> Task:
    """
    Create trend-focused research task

    Args:
        trend_query: The trending topic/query
        trend_data: Trend metadata (search volume, date, related queries)
        context: Additional context

    Returns:
        CrewAI Task instance
    """
    researcher = create_researcher_agent()

    related_queries = trend_data.get("related_queries", [])
    search_volume = trend_data.get("search_volume", "N/A")
    trend_date = trend_data.get("trend_date", "recent")

    return Task(
        description=f"""
        Research this trending topic with emphasis on timeliness and current relevance:

        Trending Topic: {trend_query}
        Search Volume: {search_volume}
        Trend Date: {trend_date}
        Related Queries: {', '.join(related_queries) if related_queries else "None"}
        {f"Additional Context: {context}" if context else ""}

        Your research goals:
        1. **Verify Trend Status**
           - Confirm trend is still active and relevant
           - Identify if this is breaking news or ongoing story

        2. **Real-Time Information**
           - Latest updates and developments (within last 24-48 hours)
           - Breaking news angles
           - Current statistics and data points

        3. **Impact Analysis**
           - Why this topic is trending now
           - Who is affected and how
           - Broader implications and significance

        4. **Expert Reactions**
           - What experts are saying
           - Social media reactions and sentiment
           - Controversial or debated aspects

        5. **Related Trends**
           - Other trending topics connected to this
           - Historical context for the trend
           - What might happen next (predictions)

        6. **Content Angle**
           - Best approach for this trend (breaking news, analysis, explainer)
           - Key questions readers want answered
           - Unique perspective to stand out

        Focus on the MOST RECENT information. Prioritize timeliness over depth.
        """,
        agent=researcher,
        expected_output="""
        A time-sensitive research brief containing:
        - Current status and latest updates
        - Why it's trending (context and significance)
        - Key facts, statistics, and data points
        - Expert opinions and reactions
        - Related trending topics
        - Recommended content angle (breaking news, analysis, etc.)
        - Timeline of recent developments
        """
    )


def create_trend_writing_task(
    trend_query: str,
    word_count: int,
    tone: str,
    research_task: Task
) -> Task:
    """
    Create trend-focused writing task

    Args:
        trend_query: The trending topic
        word_count: Target word count
        tone: Writing tone
        research_task: Trend research task

    Returns:
        CrewAI Task instance
    """
    writer = create_writer_agent()

    tone_guidance = {
        "professional": "Write in a professional, journalistic tone.",
        "casual": "Write in a casual, accessible tone.",
        "conversational": "Write in a conversational, engaging tone."
    }

    return Task(
        description=f"""
        Write a timely article about this trending topic:

        Trending Topic: {trend_query}
        Target Word Count: {word_count} words
        Tone: {tone_guidance.get(tone, tone_guidance['professional'])}

        Use the trend research to create urgent, newsworthy content.

        **Article Structure for Trending Content:**

        1. **Lede (First Paragraph)** - 50-75 words
           - The most important information first (Who, What, When, Where, Why)
           - Answer: "Why is this trending right now?"
           - Hook readers with urgency or significance

        2. **Context Section** - 15% of word count
           - Background: What led to this trend?
           - Why it matters to readers
           - Key stakeholders/people involved

        3. **Latest Updates** - 30% of word count
           - Most recent developments (chronological order)
           - Expert reactions and analysis
           - Statistics and data points
           - Social media reactions if relevant

        4. **Impact Analysis** - 30% of word count
           - Who is affected and how
           - Short-term and long-term implications
           - Controversy or debate surrounding the trend

        5. **What's Next** - 15% of word count
           - Predictions and outlook
           - What to watch for
           - Related trends to follow

        6. **Conclusion** - 10% of word count
           - Summary of key takeaways
           - Final thoughts on significance

        **Writing Guidelines for Trends:**
        - Emphasize timeliness ("as of today", "just announced", "breaking")
        - Use active voice and strong verbs
        - Keep paragraphs short (2-3 sentences for web reading)
        - Include specific timestamps where relevant
        - Avoid speculation without evidence
        - Update with "Editor's Note" style for breaking developments
        - Use present tense for current situations

        **Speed vs Quality:**
        - Prioritize getting content out quickly
        - Focus on accuracy over depth
        - Can be shorter if information is limited

        Write {word_count} words (±15% acceptable for trends) emphasizing timeliness.

        IMPORTANT: Use fast model (gpt-oss) for speed - trends are time-sensitive!
        """,
        agent=writer,
        context=[research_task],
        expected_output=f"""
        A timely trend article in markdown with:
        - Urgent, newsworthy lede
        - Latest updates and developments
        - Impact analysis and expert reactions
        - Future outlook
        - Approximately {word_count} words
        - Emphasis on timeliness and current relevance
        """
    )


def create_trend_seo_task(
    trend_query: str,
    trend_data: dict,
    writing_task: Task
) -> Task:
    """
    Create trend-focused SEO optimization task

    Args:
        trend_query: The trending topic
        trend_data: Trend metadata
        writing_task: Writing task

    Returns:
        CrewAI Task instance
    """
    seo_optimizer = create_seo_optimizer_agent()

    related_queries = trend_data.get("related_queries", [])

    return Task(
        description=f"""
        Optimize the trend article for maximum visibility and timeliness.

        Trending Topic: {trend_query}
        Related Trending Queries: {', '.join(related_queries) if related_queries else "None"}

        Your optimization tasks:

        1. **Trend Keyword Optimization**
           - Primary keyword: The main trend query
           - Secondary keywords: Related trending queries
           - Include "2024" or current date in meta if relevant
           - Target "breaking news" and "latest update" variations

        2. **News SEO Best Practices**
           - Meta title: Include "Breaking:", "Latest:", or year/date
           - Meta description: Emphasize timeliness and newsworthiness
           - Add structured data hints for news articles
           - Include last-updated timestamp suggestion

        3. **Timeliness Indicators**
           - Ensure title includes temporal markers ("2024", "Today", "Latest")
           - Verify recency language throughout ("just announced", "as of now")
           - Suggest update schedule for evolving stories

        4. **Trend-Specific Meta Data**
           - Meta Title format: "[Trend Topic]: Latest Updates for [Date/Year]"
           - Meta Description: Include "breaking", "trending", "latest"
           - URL slug: Include trend topic and year/date

        5. **Trending Content Score** (0-100)
           - Timeliness and recency indicators (35 points)
           - Trend keyword prominence (30 points)
           - News-style structure and formatting (20 points)
           - Update schedule and freshness (15 points)

        6. **Freshness Strategy**
           - Recommend update frequency (hourly, daily, as news breaks)
           - Identify sections that may need updates
           - Suggest related trends to monitor

        Return trend-optimized article with news SEO best practices.
        """,
        agent=seo_optimizer,
        context=[writing_task],
        expected_output="""
        JSON object with:
        {
          "optimized_content": "Full article (markdown)",
          "trend_keyword": "main trending topic",
          "related_trend_keywords": ["trending query 1", "trending query 2"],
          "timeliness_score": 92,
          "meta_title": "Trending Topic: Latest Updates for November 2024",
          "meta_description": "Breaking news on [topic]. Latest updates, analysis, and what's next.",
          "url_slug": "trending-topic-november-2024",
          "last_updated": "2024-11-15T14:30:00Z",
          "update_schedule": "Monitor every 6 hours for updates",
          "sections_to_watch": ["Latest Updates", "Expert Reactions"],
          "related_trends": ["trend1", "trend2"],
          "seo_score": 88,
          "readability_score": 70.2,
          "word_count": 1180,
          "reading_time_minutes": 5
        }
        """
    )
```

**Update CrewService (`services/crew_service.py`):**

```python
elif mode == "trends":
    trend_query = input_data.get("trend_query", "")
    trend_data = input_data.get("trend_data", {})
    tone = input_data.get("tone", "professional")
    context = input_data.get("context", "")

    # Validate trend data
    if not trend_query:
        raise ValueError("Trend query is required")

    # Create trend-focused tasks (uses fast model for speed)
    research_task = create_trend_research_task(
        trend_query,
        trend_data,
        context
    )
    writing_task = create_trend_writing_task(
        trend_query,
        word_count,
        tone,
        research_task
    )
    seo_task = create_trend_seo_task(
        trend_query,
        trend_data,
        writing_task
    )

    return [research_task, writing_task, seo_task]
```

**Update Content Router (`routers/content.py`):**

```python
class TrendsGenerateRequest(BaseModel):
    """Trends-based content generation request"""
    mode: Literal["trends"] = "trends"
    trend_id: str = Field(..., description="Trend ID from MongoDB")
    trend_query: str = Field(..., min_length=3, max_length=200)
    trend_data: dict = Field(..., description="Trend metadata (search_volume, date, related_queries)")
    word_count: int = Field(default=1200, ge=500, le=2500)
    tone: Literal["professional", "casual", "conversational"] = "professional"
    context: Optional[str] = Field(None, max_length=1000)
    job_id: str
    user_id: str


@router.post("/generate/trends", response_model=GenerateResponse)
async def generate_from_trends(
    request: TrendsGenerateRequest,
    background_tasks: BackgroundTasks
):
    """
    Generate timely content from trending topics

    Optimized for speed - trends are time-sensitive!
    Uses fast model (gpt-oss) instead of quality model.
    """
    try:
        logger.info(
            f"Trends generation: job_id={request.job_id}, "
            f"trend={request.trend_query}"
        )

        background_tasks.add_task(
            _execute_trends_generation,
            request
        )

        return GenerateResponse(
            success=True,
            job_id=request.job_id,
            message="Trend-based generation started (fast mode)"
        )

    except Exception as e:
        logger.error(f"Failed to queue trends generation: {e}")
        return GenerateResponse(
            success=False,
            job_id=request.job_id,
            message="Failed to start generation",
            error=str(e)
        )
```

## Definition of Done

- [ ] Trend research task definition created
- [ ] Trend writing task optimized for speed and timeliness
- [ ] Trend SEO task with news optimization
- [ ] CrewService implements "trends" mode
- [ ] Content router `/api/content/generate/trends` endpoint created
- [ ] Fast model (gpt-oss) used for speed
- [ ] Timeliness indicators in content and meta data
- [ ] Integration with Next.js trends collection
- [ ] Tests written for trend generation
- [ ] Code reviewed and approved
- [ ] Merged to dev branch

## Notes

**Implementation Status**: ⏳ Depends on VIP-10204 (task definitions), E2 (trends collection in MongoDB)

**Trends Mode Characteristics:**
- **Input**: Trend query + metadata from MongoDB trends collection
- **Speed Priority**: Uses fast model (gpt-oss) instead of quality model (llama3.1:70b)
- **Agent Flow**: Full 3-agent workflow but optimized for speed
- **Word Count Range**: 500-2500 words (typically shorter, 1000-1500)
- **Key Differentiator**: Emphasizes timeliness, breaking news angle, and recency

**Integration with E2 Trends Collection:**

Next.js fetches trend from MongoDB before calling FastAPI:

```typescript
// Get trend from MongoDB
const trend = await db.collection('trends').findOne({
  _id: new ObjectId(trendId),
  status: 'active'
});

// Call FastAPI with trend data
await fetch(`${process.env.FASTAPI_URL}/api/content/generate/trends`, {
  method: 'POST',
  body: JSON.stringify({
    mode: 'trends',
    trend_id: trend._id.toString(),
    trend_query: trend.query,
    trend_data: {
      search_volume: trend.searchVolume,
      trend_date: trend.createdAt,
      related_queries: trend.relatedQueries || []
    },
    word_count: 1200,
    // ...
  })
});
```

**Trend Article Characteristics:**
- **Lede**: Answers Who, What, When, Where, Why immediately
- **Active Voice**: "Player injured" not "Player was injured"
- **Present Tense**: "Team announces" not "Team announced" (for current events)
- **Timestamps**: "As of 2PM EST" or "Updated: Nov 15, 2024"
- **Urgency**: "Breaking:", "Just announced:", "Latest:"

**Performance Expectations (Faster than other modes):**
- Research: 20-40 seconds (focused on recent info)
- Writing: 30-60 seconds (using fast model)
- SEO: 10-20 seconds
- Total: 1-2 minutes (optimized for speed!)

**Update Strategy:**
- Initial article published quickly
- Monitor trend for updates
- Add "Editor's Note" sections for breaking updates
- Re-publish with updated timestamp
- Archive when trend is no longer active

**Timeliness Scoring:**
- Date/time mentions: +20 points
- "Breaking", "Latest", "Just" usage: +15 points
- Temporal markers in title: +15 points
- Recent sources cited: +15 points
- Update schedule defined: +10 points
- Related current trends: +10 points
- Active voice throughout: +10 points
- Present tense for current events: +5 points

**Next Stories:**
- VIP-10207: Spin existing article (shortest workflow, no research)
- VIP-10208: Bulk generation (process 10-50 articles in queue)
