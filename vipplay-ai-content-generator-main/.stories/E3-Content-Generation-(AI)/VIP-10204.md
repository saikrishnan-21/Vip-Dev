# VIP-10204: Topic-Based Content Generation Mode

**Story ID**: VIP-10204
**Story Type**: Story
**Epic**: E3-Content-Generation-(AI)
**Priority**: High
**Story Points**: 5
**Status**: To Do

## User Story

As a content creator, I want to generate articles from a topic/title so that I can quickly create comprehensive, research-backed content on specific subjects

## Acceptance Criteria

- [ ] **AC1**: Accept topic/title as input with configurable word count (500-3000)
- [ ] **AC2**: Researcher agent gathers information from knowledge base and web
- [ ] **AC3**: Writer agent generates structured article with intro, body, conclusion
- [ ] **AC4**: SEO optimizer adds keywords, meta description, and readability score
- [ ] **AC5**: Generated content returned with metadata (word count, reading time, SEO score)
- [ ] **AC6**: Support for tone customization (professional, casual, conversational)
- [ ] **AC7**: Integration with Next.js job management system

## Technical Details

**Architecture:**
- **FastAPI Role**: Execute CrewAI workflow, coordinate agents, return generated content
- **Next.js Role**: Create generation job in MongoDB, call FastAPI, store result
- **Data Flow**: Next.js → FastAPI → CrewAI Agents → Ollama → FastAPI → Next.js → MongoDB

**Topic-Based Generation Workflow:**

```
User Input (Next.js):
- topic: "Fantasy Football Week 10 Waiver Wire Targets"
- word_count: 1500
- tone: "professional"
- generate_images: false
    ↓
Next.js creates job in MongoDB (status: "queued")
    ↓
Next.js calls FastAPI /api/content/generate
    ↓
FastAPI CrewService.generate_content(mode="topic")
    ↓
Task 1: Research Task (Researcher Agent)
  → Query knowledge base for similar articles
  → Search web for current information
  → Output: Research brief (key points, statistics, insights)
    ↓
Task 2: Writing Task (Writer Agent)
  → Receives topic + research brief
  → Generates structured article:
    - Attention-grabbing introduction
    - Well-organized body sections
    - Strong conclusion with call-to-action
  → Uses Ollama llama3.1:70b for quality
  → Output: Draft article (markdown format)
    ↓
Task 3: SEO Optimization Task (SEO Optimizer Agent)
  → Analyzes draft article
  → Identifies primary and secondary keywords
  → Generates meta title (50-60 chars)
  → Generates meta description (150-160 chars)
  → Calculates SEO score (0-100)
  → Calculates readability score (Flesch-Kincaid)
  → Output: Optimized article + SEO metadata
    ↓
FastAPI returns result to Next.js
    ↓
Next.js stores in MongoDB (status: "completed")
```

**Task Definitions (`tasks/generation_tasks.py` - NEW):**

```python
"""
Content Generation Task Definitions
Defines CrewAI tasks for different generation modes
"""

from crewai import Task
from agents.researcher import create_researcher_agent
from agents.writer import create_writer_agent
from agents.seo_optimizer import create_seo_optimizer_agent


def create_research_task(topic: str, context: str = "") -> Task:
    """
    Create research task for gathering information

    Args:
        topic: Topic to research
        context: Additional context (optional)

    Returns:
        CrewAI Task instance
    """
    researcher = create_researcher_agent()

    return Task(
        description=f"""
        Research the following topic thoroughly:

        Topic: {topic}
        {f"Additional Context: {context}" if context else ""}

        Your goal is to gather comprehensive information including:
        1. Current statistics and data points
        2. Expert opinions and analysis
        3. Historical context and trends
        4. Key players, teams, or entities involved
        5. Recent news and developments

        Search both the internal knowledge base and external sources.
        Organize your findings into a clear research brief that a writer can use.
        """,
        agent=researcher,
        expected_output="""
        A well-organized research brief containing:
        - Key facts and statistics
        - Expert insights and quotes
        - Relevant historical context
        - Current trends and developments
        - Suggested structure for article
        """
    )


def create_writing_task(topic: str, word_count: int, tone: str, research_task: Task) -> Task:
    """
    Create writing task for generating article

    Args:
        topic: Article topic/title
        word_count: Target word count
        tone: Writing tone (professional, casual, conversational)
        research_task: Research task (for context)

    Returns:
        CrewAI Task instance
    """
    writer = create_writer_agent()

    tone_guidance = {
        "professional": "Write in a professional, authoritative tone with formal language.",
        "casual": "Write in a casual, friendly tone that's easy to read.",
        "conversational": "Write in a conversational tone as if talking to a friend."
    }

    return Task(
        description=f"""
        Write a comprehensive article on the following topic:

        Topic: {topic}
        Target Word Count: {word_count} words
        Tone: {tone_guidance.get(tone, tone_guidance['professional'])}

        Use the research provided by the researcher to create a well-structured article.

        Article Structure:
        1. **Introduction** (10-15% of word count)
           - Hook the reader with an interesting opening
           - Clearly state what the article covers
           - Preview key points

        2. **Main Body** (70-80% of word count)
           - Break into clear sections with headings
           - Use data and statistics from research
           - Include expert insights and analysis
           - Provide actionable advice or recommendations
           - Use bullet points and lists for readability

        3. **Conclusion** (10-15% of word count)
           - Summarize key takeaways
           - Provide final recommendations
           - End with a call-to-action

        Guidelines:
        - Use markdown formatting (## for headings, ** for bold, * for italic)
        - Back up claims with data and sources
        - Keep paragraphs short (3-4 sentences max)
        - Use examples to illustrate points
        - Avoid clichés and filler content
        - Target exactly {word_count} words (±10%)
        """,
        agent=writer,
        context=[research_task],  # Writer receives research output
        expected_output=f"""
        A complete article in markdown format with:
        - Engaging introduction
        - Well-organized body sections with headings
        - Strong conclusion
        - Approximately {word_count} words
        - Professional formatting
        """
    )


def create_seo_task(topic: str, writing_task: Task) -> Task:
    """
    Create SEO optimization task

    Args:
        topic: Article topic (for context)
        writing_task: Writing task (for article content)

    Returns:
        CrewAI Task instance
    """
    seo_optimizer = create_seo_optimizer_agent()

    return Task(
        description=f"""
        Optimize the article for search engines while maintaining readability.

        Original Topic: {topic}

        Your tasks:
        1. **Keyword Analysis**
           - Identify primary keyword (topic-related)
           - Identify 3-5 secondary keywords
           - Check keyword density (target 1-2% for primary)

        2. **Meta Data Generation**
           - Meta Title: 50-60 characters, includes primary keyword
           - Meta Description: 150-160 characters, compelling and includes primary keyword

        3. **SEO Score Calculation** (0-100)
           - Keyword usage and placement (30 points)
           - Content structure and headings (20 points)
           - Readability and engagement (20 points)
           - Meta data quality (15 points)
           - Content length and depth (15 points)

        4. **Readability Analysis**
           - Calculate Flesch-Kincaid Reading Ease score
           - Suggest improvements if needed

        5. **Content Enhancements**
           - Add keyword naturally if missing
           - Suggest better headings if needed
           - Ensure meta data is compelling

        Return the optimized article with SEO metadata in JSON format.
        """,
        agent=seo_optimizer,
        context=[writing_task],  # SEO optimizer receives article
        expected_output="""
        JSON object with:
        {
          "optimized_content": "Full article text (markdown)",
          "primary_keyword": "Main keyword",
          "secondary_keywords": ["keyword1", "keyword2", "keyword3"],
          "meta_title": "SEO-optimized title",
          "meta_description": "Compelling description",
          "seo_score": 85,
          "readability_score": 65.5,
          "word_count": 1489,
          "reading_time_minutes": 7,
          "improvements": ["Suggestion 1", "Suggestion 2"]
        }
        """
    )
```

**Update CrewService (`services/crew_service.py`):**

```python
from tasks.generation_tasks import (
    create_research_task,
    create_writing_task,
    create_seo_task
)

class CrewService:
    # ... existing code ...

    def _create_tasks_for_mode(
        self,
        mode: str,
        input_data: dict,
        word_count: int
    ) -> list[Task]:
        """Create task sequence for given mode"""

        if mode == "topic":
            topic = input_data.get("topic", "")
            tone = input_data.get("tone", "professional")
            context = input_data.get("context", "")

            # Create sequential tasks
            research_task = create_research_task(topic, context)
            writing_task = create_writing_task(topic, word_count, tone, research_task)
            seo_task = create_seo_task(topic, writing_task)

            return [research_task, writing_task, seo_task]

        elif mode == "keywords":
            # Will be implemented in VIP-10205
            pass

        elif mode == "trends":
            # Will be implemented in VIP-10206
            pass

        elif mode == "spin":
            # Will be implemented in VIP-10207
            pass

        else:
            raise ValueError(f"Unsupported generation mode: {mode}")
```

**Update Content Router (`routers/content.py`):**

```python
"""
Content generation router
Full implementation for topic-based generation
"""

from fastapi import APIRouter, HTTPException, BackgroundTasks
from pydantic import BaseModel, Field
from services.crew_service import crew_service
from typing import Optional, Literal
import logging

router = APIRouter(prefix="/api/content", tags=["content"])
logger = logging.getLogger(__name__)


class TopicGenerateRequest(BaseModel):
    """Topic-based content generation request"""
    mode: Literal["topic"] = "topic"
    topic: str = Field(..., min_length=5, max_length=200, description="Article topic or title")
    word_count: int = Field(default=1500, ge=500, le=3000, description="Target word count")
    tone: Literal["professional", "casual", "conversational"] = "professional"
    context: Optional[str] = Field(None, max_length=1000, description="Additional context")
    job_id: str = Field(..., description="Job ID from Next.js (for tracking)")
    user_id: str = Field(..., description="User ID from Next.js")


class GenerateResponse(BaseModel):
    """Content generation response"""
    success: bool
    job_id: str
    message: str
    content: Optional[dict] = None
    error: Optional[str] = None


@router.post("/generate/topic", response_model=GenerateResponse)
async def generate_from_topic(request: TopicGenerateRequest, background_tasks: BackgroundTasks):
    """
    Generate content from a topic/title

    This endpoint triggers the CrewAI workflow:
    1. Research the topic
    2. Write the article
    3. Optimize for SEO

    Returns immediately with job_id, actual generation runs in background.
    Next.js should poll /api/content/job/{job_id} for status.
    """
    try:
        logger.info(f"Topic generation request: job_id={request.job_id}, topic={request.topic}")

        # Queue background task
        background_tasks.add_task(
            _execute_topic_generation,
            request
        )

        return GenerateResponse(
            success=True,
            job_id=request.job_id,
            message="Content generation started. Poll /api/content/job/{job_id} for status."
        )

    except Exception as e:
        logger.error(f"Failed to queue generation: {e}")
        return GenerateResponse(
            success=False,
            job_id=request.job_id,
            message="Failed to start generation",
            error=str(e)
        )


async def _execute_topic_generation(request: TopicGenerateRequest):
    """
    Execute topic-based generation in background

    Note: In production, this should update job status in a shared cache/database
    that Next.js can query. For now, FastAPI returns result which Next.js will store.
    """
    try:
        result = await crew_service.generate_content(
            mode="topic",
            input_data={
                "topic": request.topic,
                "tone": request.tone,
                "context": request.context or ""
            },
            word_count=request.word_count
        )

        logger.info(f"Topic generation completed: job_id={request.job_id}")

        # TODO: Notify Next.js via webhook or store in shared cache
        # For now, result is returned via sync endpoint below

    except Exception as e:
        logger.error(f"Topic generation failed: job_id={request.job_id}, error={e}")
        # TODO: Update job status to failed


# Placeholder for job status endpoint (to be implemented in VIP-10211)
@router.get("/job/{job_id}")
async def get_job_status(job_id: str):
    """Get status of content generation job"""
    raise HTTPException(
        status_code=501,
        detail="Job status endpoint not yet implemented. See VIP-10211."
    )
```

**Integration with Next.js:**

```typescript
// Example from Next.js API route (app/api/content/generate/route.ts)

export async function POST(request: NextRequest) {
  const session = await getServerSession(authOptions);
  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const body = await request.json();
  const { mode, topic, wordCount, tone } = body;

  // Create job in MongoDB
  const job = await db.collection('generation_jobs').insertOne({
    userId: session.user.id,
    mode: 'topic',
    topic,
    wordCount,
    tone,
    status: 'queued',
    createdAt: new Date(),
  });

  // Call FastAPI to generate content
  const fastapiResponse = await fetch(`${process.env.FASTAPI_URL}/api/content/generate/topic`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      mode: 'topic',
      topic,
      word_count: wordCount,
      tone,
      job_id: job.insertedId.toString(),
      user_id: session.user.id,
    }),
  });

  const result = await fastapiResponse.json();

  if (result.success) {
    // Update job status
    await db.collection('generation_jobs').updateOne(
      { _id: job.insertedId },
      { $set: { status: 'processing' } }
    );

    return NextResponse.json({
      success: true,
      jobId: job.insertedId.toString(),
      message: 'Content generation started',
    });
  } else {
    return NextResponse.json(
      { error: result.error || 'Generation failed' },
      { status: 500 }
    );
  }
}
```

**Testing:**

```python
# tests/test_topic_generation.py
"""Test topic-based content generation"""

import pytest
from services.crew_service import crew_service

@pytest.mark.asyncio
async def test_topic_generation():
    """Test full topic-based generation workflow"""
    result = await crew_service.generate_content(
        mode="topic",
        input_data={
            "topic": "Fantasy Football Week 10 Waiver Wire Picks",
            "tone": "professional",
            "context": ""
        },
        word_count=1500
    )

    assert result["success"] == True
    assert "content" in result

    # Verify content structure
    content = result["content"]
    assert "optimized_content" in content
    assert "meta_title" in content
    assert "meta_description" in content
    assert "seo_score" in content
    assert content["word_count"] >= 1350  # Within 10% of target
    assert content["word_count"] <= 1650
```

## Definition of Done

- [ ] Research task definition created in `tasks/generation_tasks.py`
- [ ] Writing task definition created with tone support
- [ ] SEO optimization task definition created
- [ ] CrewService `_create_tasks_for_mode` implements "topic" mode
- [ ] Content router `/api/content/generate/topic` endpoint created
- [ ] Background task execution implemented
- [ ] Integration with Next.js documented
- [ ] Tests written and passing for topic generation
- [ ] Word count accuracy within ±10%
- [ ] SEO metadata generation validated
- [ ] Code reviewed and approved
- [ ] Merged to dev branch

## Notes

**Implementation Status**: ⏳ Depends on VIP-10202 (CrewAI agents), VIP-10203 (Ollama)

**Topic Mode Characteristics:**
- **Input**: Simple topic/title string
- **Research Depth**: High (uses both knowledge base and web search)
- **Agent Flow**: Full 3-agent workflow (Research → Write → SEO)
- **Word Count Range**: 500-3000 words
- **Tone Support**: Professional, casual, conversational

**Example Topics:**
- "Fantasy Football Week 10 Waiver Wire Targets"
- "Top NCAA Basketball Recruits for 2024"
- "NFL Draft Quarterback Rankings"
- "Fantasy Basketball Sleepers for Playoffs"

**Performance Expectations:**
- **Research Phase**: 30-60 seconds
- **Writing Phase**: 60-120 seconds (depends on word count and model)
- **SEO Phase**: 15-30 seconds
- **Total**: 2-4 minutes for 1500-word article

**Error Handling:**
- Research failure: Use topic alone without additional research
- Writing timeout: Return partial content with warning
- SEO failure: Return article without SEO metadata
- All failures logged with full context

**Next Stories:**
- VIP-10205: Keywords-based generation (similar structure, different research focus)
- VIP-10206: Trends-based generation (integrates with Google Trends)
- VIP-10207: Spin existing article (shorter workflow, no research)
- VIP-10211: Job status polling and progress tracking
