# VIP-10503: Test Model Connection

**Story ID**: VIP-10503
**Story Type**: Story
**Epic**: E6-AI-Configuration-(Superadmin)
**Priority**: Medium
**Story Points**: 3
**Status**: ✅ Complete

## User Story

As a superadmin, I want to test model connections so that I can verify they're working

## Acceptance Criteria

- [x] **AC1**: Superadmin can test model connection via API endpoint
- [x] **AC2**: API sends test prompt to model and measures response time
- [x] **AC3**: API returns success/failure status with response details
- [x] **AC4**: API supports custom test prompts (optional, defaults to standard prompt)
- [x] **AC5**: Non-superadmin users receive 403 Forbidden error
- [x] **AC6**: API handles model unavailability gracefully

## Technical Details

**API Endpoint**: `POST /api/admin/ai/models/test`

**Authentication**: Requires JWT token with `superadmin` role

**Request Body**:
```json
{
  "model": "llama3.1:8b",
  "prompt": "Hello, respond with \"OK\" if you can read this." // optional
}
```

**Data Flow**:
```
Next.js API → FastAPI: POST /models/test → Ollama API (generate) → FastAPI → Next.js API → Frontend
```

**Implementation Files**:
- `app/api/admin/ai/models/test/route.ts` - Next.js API route (lines 17-119)
- `api-service/main.py` - FastAPI endpoint (lines 128-177)
- `api-service/services/ollama_service.py` - Ollama generate method

**Response Format (Success)**:
```json
{
  "message": "Model test successful",
  "result": {
    "model": "llama3.1:8b",
    "success": true,
    "responseTime": 1250,
    "response": "OK",
    "testedAt": "2025-01-15T10:30:00Z"
  }
}
```

**Response Format (Failure)**:
```json
{
  "message": "Model test failed",
  "result": {
    "model": "llama3.1:8b",
    "success": false,
    "responseTime": 500,
    "error": "Model not found",
    "testedAt": "2025-01-15T10:30:00Z"
  }
}
```

**Error Responses**:
- `400 Bad Request` - Missing model name
- `401 Unauthorized` - Missing or invalid token
- `403 Forbidden` - User is not superadmin
- `503 Service Unavailable` - FastAPI or Ollama unavailable

## Definition of Done

- [x] Code implemented and working
- [x] All acceptance criteria met
- [x] E2E tests written and passing (tests/e2e/e6-ai-configuration.spec.ts)
- [x] Code reviewed and approved
- [x] Merged to main branch
- [x] Documented (ARCHITECTURE.md updated)

## Notes

**Implementation Notes**:
- Next.js API route proxies to FastAPI service (not direct Ollama calls)
- FastAPI endpoint: `POST /models/test` calls Ollama generate method
- No mock data - uses real Ollama API via FastAPI
- Test measures actual response time from Ollama
- Supports custom test prompts (optional parameter)
- FastAPI Swagger available at `http://localhost:8000/docs`
