# VIP-10507: Superadmin Access Control

**Story ID**: VIP-10507
**Story Type**: Story
**Epic**: E6-AI-Configuration-(Superadmin)
**Priority**: High
**Story Points**: 3
**Status**: ✅ Complete

## User Story

As a developer, I want to restrict AI config to superadmins so that regular users can't change settings

## Acceptance Criteria

- [x] **AC1**: All AI configuration endpoints require superadmin role
- [x] **AC2**: Regular users receive 403 Forbidden when accessing admin endpoints
- [x] **AC3**: Unauthenticated requests receive 401 Unauthorized
- [x] **AC4**: JWT token validation checks role field for "superadmin"
- [x] **AC5**: All admin endpoints verify token before processing requests
- [x] **AC6**: Access control is enforced consistently across all E6 endpoints

## Technical Details

**Protected Endpoints** (All require superadmin role):
- `/api/admin/ai/models` (GET, POST, DELETE)
- `/api/admin/ai/models/test` (POST, PUT)
- `/api/admin/ai/groups` (GET, POST)
- `/api/admin/ai/groups/{id}` (GET, PATCH, DELETE)
- `/api/admin/ai/config` (GET, POST, PUT, PATCH)
- `/api/admin/ai/config/{id}` (GET, PATCH, DELETE)

**Authentication Flow**:
```
Request → Extract JWT token from Authorization header
  → Verify token (verifyToken from @/lib/auth/jwt)
  → Check payload.role === 'superadmin'
  → Allow/Deny access
```

**Implementation Pattern** (used in all E6 routes):
```typescript
const token = request.headers.get('authorization')?.replace('Bearer ', '');
if (!token) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}

const payload = verifyToken(token);
if (!payload) {
  return NextResponse.json({ error: 'Invalid token' }, { status: 401 });
}

if (payload.role !== 'superadmin') {
  return NextResponse.json(
    { error: 'Forbidden. Superadmin access required.' },
    { status: 403 }
  );
}
```

**Implementation Files**:
- All files in `app/api/admin/ai/` use this pattern
- `lib/auth/jwt.ts` - JWT verification function

**Error Responses**:
- `401 Unauthorized` - Missing token or invalid token
- `403 Forbidden` - Valid token but role is not "superadmin"

**Test Coverage**:
- Regular user attempting admin access → 403
- Unauthenticated request → 401
- Superadmin access → 200/201/202 (success)

## Definition of Done

- [x] Code implemented and working
- [x] All acceptance criteria met
- [x] E2E tests written and passing (tests/e2e/e6-ai-configuration.spec.ts)
- [x] Code reviewed and approved
- [x] Merged to main branch
- [x] Documented (ARCHITECTURE.md updated)

## Notes

**Implementation Notes**:
- All E6 endpoints use consistent authentication pattern
- JWT token verification checks `role === 'superadmin'`
- Access control enforced in every route handler
- Regular users and admins cannot access AI configuration endpoints
- All endpoints return appropriate 401/403 errors for unauthorized access
