# VIP-10107: Generate Article Vector Embeddings

**Story ID**: VIP-10107
**Story Type**: Story
**Epic**: E2-Knowledge-Base-System
**Priority**: Medium
**Story Points**: 5
**Status**: To Do

## User Story

As a system, I want to generate embeddings for articles so that I can find similar content

## Acceptance Criteria

- [x] **AC1**: System generates vector embeddings for articles using Ollama
- [x] **AC2**: Embeddings are stored in Weaviate with article metadata
- [x] **AC3**: Articles in MongoDB are flagged with `hasEmbedding: true`
- [x] **AC4**: Endpoint supports single article embedding generation
- [x] **AC5**: Article embeddings include title and content combined

## Technical Details

**Architecture:**
- Next.js API routes handle database operations and orchestration
- FastAPI service handles heavy lifting (embedding generation and Weaviate storage)
- Communication: Next.js → FastAPI → Ollama (embeddings) → Weaviate (storage)

**Next.js Endpoint:**
- `POST /api/articles/{articleId}/embeddings` - Generate embedding for single article
- JWT authentication required
- MongoDB operations for updating article metadata
- Validates article ownership

**FastAPI Endpoints:**
- `POST /api/embeddings/article` - Generate embedding and store in Weaviate
- `POST /api/embeddings/search` - Search similar articles by vector (bonus feature)

**Weaviate Service (FastAPI):**
- Create "Article" collection schema if not exists
- Store embedding vectors with article metadata
- Support update if article already has embedding
- Enable similarity search capabilities

**Embedding Generation:**
- Use Ollama `nomic-embed-text` model
- Combine article title and content: `{title}\n\n{content}`
- Generate embedding vector (768 dimensions for nomic-embed-text)
- Store vector in Weaviate, not MongoDB

**Data Model Updates (Article):**
```typescript
{
  hasEmbedding?: boolean,      // Flag indicating embedding exists
  embeddingModel?: string,     // Model used (e.g., "nomic-embed-text")
  weaviateUuid?: string,       // Weaviate object UUID reference
}
```

**Weaviate Schema (Article Collection):**
```python
{
  "articleId": "text",         # MongoDB article ID
  "title": "text",            # Article title (for reference)
  "content": "text",          # Truncated content (first 1000 chars)
  "vector": [float],          # Embedding vector
}
```

**Error Handling:**
- Handle Ollama service unavailable
- Handle Weaviate connection errors
- Handle invalid article ID
- Handle unauthorized access
- Log all errors for monitoring

## Definition of Done

- [ ] Code implemented and working
- [ ] All acceptance criteria met
- [ ] Unit tests written and passing
- [ ] Code reviewed and approved
- [ ] Merged to main branch
- [ ] Documented

## Notes

**Implementation Status**: ✅ Code Complete

**Architecture Implementation**:
1. ✅ FastAPI Service (`api-service/`):
   - Created `services/weaviate_service.py` - Vector storage and retrieval
   - Updated `routers/embeddings.py` - Added article embedding endpoints
   - Created `models/embedding_models.py` - Pydantic models for requests/responses
   - Added `weaviate-client>=4.0.0` to requirements.txt

2. ✅ Next.js Backend (`app/api/`):
   - Created `app/api/articles/[articleId]/embeddings/route.ts` - Orchestration endpoint
   - Updated `lib/types/article.ts` - Added embedding-related fields
   - JWT authentication enforced
   - Article ownership verified

**Correct Data Flow**:
- User → Next.js (auth, DB) → FastAPI (embedding generation) → Ollama → Weaviate
- Separation of concerns: Next.js = orchestration + MongoDB, FastAPI = AI operations + Weaviate

**Endpoints Ready**:
- Next.js: `POST /api/articles/{articleId}/embeddings` → Validates & calls FastAPI
- FastAPI: `POST /api/embeddings/article` → Generates embedding & stores in Weaviate
- FastAPI: `POST /api/embeddings/search` → Vector similarity search (bonus)

**Weaviate Integration**:
- Auto-creates "Article" collection schema on first connection
- Stores vectors with articleId, title, content metadata
- Supports update operations for existing embeddings
- Enables similarity search with certainty threshold

**Code Quality**:
- JWT authentication enforced (Next.js)
- Article ownership verified (Next.js)
- Single article processing (as per requirements)
- Weaviate schema created automatically (FastAPI)
- MongoDB articles updated with hasEmbedding flag (Next.js)
- Proper error handling (400, 404, 500, 503)
- Clean separation of concerns (Next.js vs FastAPI)
- Environment variables for all configurations
