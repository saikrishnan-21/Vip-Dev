# VIP-10109: Vector Similarity Search

**Story ID**: VIP-10109
**Story Type**: Story
**Epic**: E2-Knowledge-Base-System
**Priority**: Medium
**Story Points**: 5
**Status**: To Do

## User Story

As a user, I want to find similar articles so that I can discover related content

## Acceptance Criteria

- [x] **AC1**: Users can search for similar articles by query text
- [x] **AC2**: Users can find articles similar to a given article (by articleId)
- [x] **AC3**: Search uses vector similarity via Weaviate
- [x] **AC4**: Results include similarity score (certainty 0-1)
- [x] **AC5**: Supports certainty threshold filtering (min similarity)
- [x] **AC6**: Supports filtering by source and limit parameters

## Technical Details

**Architecture:**
- Next.js API routes handle orchestration and MongoDB operations
- FastAPI service handles vector similarity search via Weaviate
- Communication: Next.js → FastAPI → Ollama (embedding) → Weaviate (search)

**Endpoint:**
- `GET /api/articles/semantic-search` - Vector similarity search
- JWT authentication required
- User can only search their own articles

**Query Parameters:**
- `q` (optional): Search query text (either q or articleId required)
- `articleId` (optional): Find articles similar to this article
- `sourceId` (optional): Filter by specific source
- `certainty` (optional): Minimum similarity score 0-1 (default: 0.7)
- `limit` (optional): Maximum results (default: 10, min: 1, max: 100)

**Search Modes:**
1. **Text Query Search**: Provide `q` parameter with search text
2. **Similar Article Search**: Provide `articleId` to find similar articles

**Data Flow:**
1. Next.js validates parameters and user auth
2. If articleId provided, fetch article details from MongoDB
3. Call FastAPI `/api/embeddings/search` with query text
4. FastAPI generates embedding using Ollama
5. FastAPI searches Weaviate for similar vectors
6. Next.js retrieves full article details from MongoDB
7. Next.js filters by source if specified
8. Returns articles with certainty scores

**Response Format:**
```json
{
  "success": true,
  "query": "keyword or articleId",
  "articles": [
    {
      ...articleFields,
      "score": 0.85
    }
  ],
  "count": 5,
  "certainty": 0.7
}
```

**Dependencies:**
- Requires embeddings to be generated (VIP-10107)
- Uses FastAPI Weaviate service
- Uses Ollama embedding model (nomic-embed-text)

**Error Handling:**
- Handle invalid parameters (400)
- Handle article not found (404)
- Handle FastAPI unavailable (503)
- Handle Weaviate errors (500)
- Log errors for monitoring

## Definition of Done

- [ ] Code implemented and working
- [ ] All acceptance criteria met
- [ ] Unit tests written and passing
- [ ] Code reviewed and approved
- [ ] Merged to main branch
- [ ] Documented

## Notes

**Implementation Status**: ✅ Code Complete

**Architecture Implementation**:
1. ✅ Next.js Backend (`app/api/`):
   - Updated `app/api/articles/semantic-search/route.ts` - Vector similarity search
   - Replaced MongoDB Atlas Vector Search with Weaviate
   - Added support for search by query text or article ID
   - Integrated with FastAPI Weaviate service

2. ✅ FastAPI Service (from VIP-10107):
   - Already implemented `POST /api/embeddings/search` endpoint
   - Generates embedding using Ollama
   - Searches Weaviate for similar vectors
   - Returns results with certainty scores

**Key Features**:
- Two search modes: text query or similar to article
- Vector similarity via Weaviate
- Certainty score filtering (0-1 scale)
- Source filtering support
- Configurable result limit (1-100)
- Proper parameter validation
- User isolation and authentication

**Code Quality**:
- JWT authentication enforced
- Article ownership verified
- Parameter validation (limit, certainty)
- Proper error handling (400, 404, 503, 500)
- Clean separation: Next.js (orchestration) + FastAPI (vector ops)
- Results sorted by similarity score

**Dependencies**:
- Requires VIP-10107 (embeddings) to be generated first
- Uses FastAPI Weaviate service
- Uses Ollama nomic-embed-text model
