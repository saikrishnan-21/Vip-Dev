# VIP-10106: Crawl and Extract Website Content

**Story ID**: VIP-10106
**Story Type**: Story
**Epic**: E2-Knowledge-Base-System
**Priority**: High
**Story Points**: 8
**Status**: To Do

## User Story

As a system, I want to crawl websites using Firecrawl so that I can extract clean article content

## Acceptance Criteria

- [ ] **AC1**: System initiates website crawl via Firecrawl API
- [ ] **AC2**: Crawled pages are extracted and stored as articles in MongoDB
- [ ] **AC3**: Duplicate articles are prevented (by URL)
- [ ] **AC4**: Crawl job status can be checked and monitored
- [ ] **AC5**: Article content includes clean markdown, title, description, and metadata

## Technical Details

**Architecture:**
- Next.js API routes handle database operations and orchestration
- FastAPI service handles heavy lifting (Firecrawl integration)
- Communication: Next.js → FastAPI → Firecrawl → FastAPI → Next.js

**Next.js Endpoints:**
- `POST /api/sources/{sourceId}/crawl` - Validate source, call FastAPI, store jobId
- `GET /api/sources/{sourceId}/crawl` - Get status from FastAPI, process results
- JWT authentication required
- MongoDB operations for storing articles

**FastAPI Endpoints:**
- `POST /crawl` - Initiate crawl with Firecrawl API
- `GET /crawl/{jobId}` - Check Firecrawl job status
- `POST /crawl/scrape` - Scrape single page (optional)

**Firecrawl Integration (FastAPI):**
- Use Firecrawl API v1 for website crawling
- Crawl options: maxPages (default: 50), formats: ['markdown']
- Extract clean content by including article/main/content tags
- Exclude nav/footer/header/aside tags

**Data Flow:**
1. User → Next.js: POST /api/sources/{sourceId}/crawl
2. Next.js → Validates source ownership and type
3. Next.js → FastAPI: POST /crawl with websiteUrl
4. FastAPI → Firecrawl API: Initiate crawl job
5. Firecrawl → FastAPI: Returns jobId
6. FastAPI → Next.js: Returns jobId
7. Next.js → MongoDB: Store jobId in source document
8. User polls Next.js: GET /api/sources/{sourceId}/crawl
9. Next.js → FastAPI: GET /crawl/{jobId}
10. FastAPI → Firecrawl API: Check job status
11. If completed:
    - FastAPI → Next.js: Return crawled pages data
    - Next.js processes pages: extract metadata, check duplicates
    - Next.js → MongoDB: Bulk insert new articles
    - Next.js → MongoDB: Update source's articlesCount

**Error Handling:**
- 400: Invalid source ID or non-website source
- 404: Source not found or no crawl job
- 500: Firecrawl API errors
- 202: Accepted (crawl initiated)
- 200: OK (job status returned)

## Definition of Done

- [ ] Code implemented and working
- [ ] All acceptance criteria met
- [ ] Unit tests written and passing
- [ ] Code reviewed and approved
- [ ] Merged to main branch
- [ ] Documented

## Notes

**Implementation Status**: ✅ Code Complete (Requires Firecrawl API Key for Production)

**Architecture Implementation**:
1. ✅ FastAPI Service (`api-service/`):
   - Created `services/firecrawl_service.py` - Firecrawl API wrapper
   - Created `routers/crawl.py` - Crawl endpoints (POST /crawl, GET /crawl/{jobId}, POST /crawl/scrape)
   - Created `models/crawl_models.py` - Pydantic models for requests/responses
   - Integrated crawl router into `main.py`
   - Added FIRECRAWL_API_KEY to `.env.example`

2. ✅ Next.js Backend (`app/api/`):
   - Updated `app/api/sources/[sourceId]/crawl/route.ts` to call FastAPI endpoints
   - Removed direct Firecrawl integration from Next.js (`lib/services/firecrawl.ts` deleted)
   - Next.js 16 compatibility (`await context.params`)
   - Proper Article typing (`Omit<Article, '_id'>`)
   - MongoDB operations: store jobId, process crawled articles, update counts

**Correct Data Flow**:
- User → Next.js (auth, DB) → FastAPI (heavy lifting) → Firecrawl API
- Separation of concerns: Next.js = orchestration + DB, FastAPI = AI/crawling operations

**Environment Variables**:
- FastAPI: `FIRECRAWL_API_KEY` in `api-service/.env`
- Next.js: `FASTAPI_URL=http://localhost:8000` in `.env.local`

**Firecrawl API Requirement**:
- API key must be configured in `api-service/.env` as `FIRECRAWL_API_KEY`
- Currently set to placeholder value: `your-firecrawl-api-key`
- Sign up at https://firecrawl.dev for production API key

**Endpoints Ready**:
- Next.js: `POST /api/sources/{sourceId}/crawl` → Validates & calls FastAPI
- Next.js: `GET /api/sources/{sourceId}/crawl` → Checks FastAPI status & stores results
- FastAPI: `POST /crawl` → Initiates Firecrawl job
- FastAPI: `GET /crawl/{jobId}` → Returns job status and crawled data

**Code Quality**:
- JWT authentication enforced (Next.js)
- Source ownership verified (Next.js)
- Duplicate detection by URL (Next.js)
- Proper error handling (400, 404, 500, 503)
- Async job processing (Firecrawl)
- Bulk insert for efficiency (MongoDB)
- Article count updates automatically (MongoDB)
- Clean separation of concerns (Next.js vs FastAPI)
