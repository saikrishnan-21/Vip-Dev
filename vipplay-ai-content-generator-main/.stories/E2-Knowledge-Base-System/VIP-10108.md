# VIP-10108: Full-Text Search Articles

**Story ID**: VIP-10108
**Story Type**: Story
**Epic**: E2-Knowledge-Base-System
**Priority**: High
**Story Points**: 3
**Status**: To Do

## User Story

As a user, I want to search articles by keywords so that I can find relevant content quickly

## Acceptance Criteria

- [x] **AC1**: Users can search articles by keywords using full-text search
- [x] **AC2**: Search supports pagination (page, limit parameters)
- [x] **AC3**: Search supports filtering by source and tags
- [x] **AC4**: Search results can be sorted by relevance, date, title, or fetchedAt
- [x] **AC5**: Query parameter is optional - can browse all articles without search term
- [x] **AC6**: Returns helpful error if MongoDB text index is not configured

## Technical Details

**Architecture:**
- Next.js API route handles full-text search (database operation, not external service)
- MongoDB text search using $text operator
- No FastAPI involvement (pure database query)

**Endpoint:**
- `GET /api/articles/search` - Full-text search with filters and pagination
- JWT authentication required
- User can only search their own articles

**Query Parameters:**
- `q` (optional): Search query text (if omitted, returns all articles)
- `sourceId` (optional): Filter by specific source
- `tags` (optional): Comma-separated tags to filter by (matches any tag)
- `sortBy` (optional): Sort field - `relevance`, `date`, `title`, `fetchedAt` (default: relevance if query provided, fetchedAt otherwise)
- `sortOrder` (optional): Sort order - `asc`, `desc` (default: desc)
- `page` (optional): Page number (default: 1, min: 1)
- `limit` (optional): Results per page (default: 20, min: 1, max: 100)

**MongoDB Text Index Required:**
```javascript
db.articles.createIndex({
  title: "text",
  content: "text",
  summary: "text"
});
```

**Search Features:**
- Full-text search across title, content, and summary fields
- Relevance scoring when sorting by relevance
- Filter by source ID
- Filter by tags (OR logic - matches any tag)
- Multiple sort options (relevance, date, title, fetchedAt)
- Pagination with metadata (page, limit, total, totalPages, hasNextPage, hasPrevPage)
- Validation for pagination parameters

**Response Format:**
```json
{
  "success": true,
  "query": "keyword",
  "articles": [...],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 150,
    "totalPages": 8,
    "hasNextPage": true,
    "hasPrevPage": false
  },
  "filters": {
    "sourceId": "...",
    "tags": ["tag1", "tag2"],
    "sortBy": "relevance",
    "sortOrder": "desc"
  }
}
```

**Error Handling:**
- Handle invalid pagination parameters (400)
- Handle missing text index (500 with helpful message)
- Handle database errors (500)
- Log errors for monitoring

## Definition of Done

- [ ] Code implemented and working
- [ ] All acceptance criteria met
- [ ] Unit tests written and passing
- [ ] Code reviewed and approved
- [ ] Merged to main branch
- [ ] Documented

## Notes

**Implementation Status**: ✅ Code Complete

**Architecture Implementation**:
1. ✅ Next.js Backend (`app/api/`):
   - Enhanced `app/api/articles/search/route.ts` - Full-text search endpoint
   - Added advanced filtering (sourceId, tags)
   - Added multiple sort options (relevance, date, title, fetchedAt)
   - Added pagination metadata (hasNextPage, hasPrevPage)
   - Made search query optional (can browse all articles)

**Key Features**:
- Full-text search using MongoDB $text operator
- Relevance scoring with $meta: textScore
- Optional query parameter (browse without search)
- Filter by source ID
- Filter by tags (OR logic)
- Multiple sort options with custom order
- Comprehensive pagination
- Parameter validation
- Helpful error message if text index missing

**Code Quality**:
- JWT authentication enforced
- User isolation (search only own articles)
- Pagination validation (page >= 1, limit 1-100)
- Proper error handling (400, 500)
- Helpful error message for missing index
- Clean response format with metadata

**Database Requirements**:
- MongoDB text index on title, content, summary fields
- Command: `db.articles.createIndex({ title: "text", content: "text", summary: "text" })`
